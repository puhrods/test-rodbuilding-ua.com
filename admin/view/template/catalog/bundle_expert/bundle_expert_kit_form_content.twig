
<div id="content">
    <div class="page-header kit-page-header">

        {{ bundle_expert_navigation }}

        <div class="container-fluid">
            <div class="pull-right">

                <button onclick="save_kit_ajax(this, false);" data-toggle="tooltip" title="{{ button_save }}" class="btn btn-primary" ><i class="fa fa-save"></i></button>
                <!--                    <button type="button" id="filter-button" data-toggle="tooltip" title="-->{# echo $button_filter; #}<!--" class="btn btn-default" onclick="on_filter_button();"><i class="fa fa-filter"></i></button>-->
                <!--        <a onclick="save();"  title="-->{# echo $button_save; #}<!--" class="btn btn-primary"><i class="fa fa-save"></i></a>-->

                <button id="button-save-and-stay" onclick="save_kit_ajax(this, true);" data-toggle="tooltip" title="{{ text_save_and_stay }}" class="btn btn-success"><i class="fa fa-check"></i></button>

                <a href="{{ cancel }}" data-toggle="tooltip" title="{{ button_cancel }}" class="btn btn-default"><i class="fa fa-reply"></i></a>
                {% if (delete_href) %}
                    <a data-toggle="tooltip" data-href="{{ delete_href }}" title="{{ button_delete }}" class="btn btn-danger" onclick="confirm('{{ text_confirm }}') ? delete_kit(this) : false;"><i class="fa fa-trash-o"></i></a>
                {% endif %}

            </div>
            <h1>{{ heading_title }}</h1>
            <ul class="breadcrumb">
                {% for breadcrumb in breadcrumbs %}
                    <li><a href="{{ breadcrumb['href'] }}">{{ breadcrumb['text'] }}</a></li>
                {% endfor %}
            </ul>
        </div>
    </div>
    <div class="container-fluid">
        {% if (error_warning) %}
            <div class="alert alert-danger"><i class="fa fa-exclamation-circle"></i> {{ error_warning }}
                <button type="button" class="close" data-dismiss="alert">&times;</button>
            </div>
        {% endif %}
        <div class="panel panel-default">
            <div class="panel-heading main-panel-heading">
                <h3 class="panel-title"><i class="fa fa-pencil"></i> {{ text_form }}</h3>
            </div>
            <div class="panel-body {% if (main_mode == 'series' or main_mode == 'collection') %} {{ 'main-mode-series' }}{% else %} {{ 'main-mode-kits' }}{% endif %} ">
                <form action="{{ action }}" method="post" enctype="multipart/form-data" id="form-kit" class="form-horizontal">
                    <input type="hidden" name="kit_id" value="{{ kit_id }}">
                    <ul class="nav nav-tabs">
                        <li class="active"><a href="#tab-general" data-toggle="tab">{{ tab_general }}</a></li>
                        <li class=""><a href="#tab-data" data-toggle="tab">{{ tab_data }}</a></li>
                        <li class=""><a href="#tab-product" data-toggle="tab">{{ text_products }}</a></li>
                        {% if (groups_enable) %}
                            <li class=""><a href="#tab-groups" data-toggle="tab">{{ text_tab_groups }}</a></li>
                        {% endif %}
                        <li class=""><a href="#tab-widget" data-toggle="tab">{{ text_widgets }}</a></li>
                        <li><a href="#tab-kit-period" data-toggle="tab">{{ tab_kit_period }}</a></li>
                        <li class="hide-for-series"><a href="#tab-log" data-toggle="tab">{{ text_kits_log }}</a></li>
                    </ul>
                    <div class="tab-content">
                        <div class="tab-pane active in" id="tab-general">
                            <div class="form-group">
                                <label class="col-sm-2 control-label" for="input-title">
                                    {{ entry_name }}
                                    <div class="be-label-note show-for-import-mode">{kit_id}, {kit_index}, {link_product_name}</div>
                                </label>
                                <div class="col-sm-10">
                                    <input type="text" name="name" value="{{ name }}" placeholder="{{ entry_name }}" id="input-title" class="form-control" />
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="col-sm-2 control-label" for="input-title">{{ entry_title_description }}</label>
                                <div class="col-sm-10">
                                    <ul class="nav nav-tabs" id="language">
                                        {% for language in languages %}
                                            <li><a href="#language{{ language['language_id'] }}" data-toggle="tab"><img src="{{ language['image_url'] }}" title="{{ language['name'] }}" /> {{ language['name'] }}</a></li>
                                        {% endfor %}
                                    </ul>

                                    <div class="tab-content">
                                        {% for language in languages %}
                                            <div class="tab-pane" id="language{{ language['language_id'] }}">
                                                <div class="form-group required">
                                                    <div class="col-sm-12">
                                                        <input type="text" name="kit_description[{{ language['language_id'] }}][title]" value="{{ kit_description[language['language_id']] is defined ? kit_description[language['language_id']]['title'] : '' }}" placeholder="{{ entry_name }}" id="input-title{{ language['language_id'] }}" class="form-control" />
                                                        <div class="kit-name-error-container{{ language['language_id'] }}"></div>
                                                        {% if (error_name[language['language_id']] is defined) %}
                                                            <div class="text-danger">{{ error_name[language['language_id']] }}</div>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                                <div class="form-group">
                                                    <div class="col-sm-12">
                                                        <textarea name="kit_description[{{ language['language_id'] }}][description]" placeholder="{{ entry_description }}" id="input-description{{ language['language_id'] }}" class="form-control">{{ kit_description[language['language_id']] is defined ? kit_description[language['language_id']]['description'] : '' }}</textarea>
                                                    </div>
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>


                            <div class="form-group hide-for-series">
                                <label class="col-sm-2 control-label" for="input-title">{{ entry_cart_title }}</label>
                                <div class="col-sm-10">
                                    <ul class="nav nav-tabs" id="cart-language">
                                        {% for language in languages %}
                                            <li><a href="#cart-language{{ language['language_id'] }}" data-toggle="tab"><img src="{{ language['image_url'] }}" title="{{ language['name'] }}" /> {{ language['name'] }}</a></li>
                                        {% endfor %}
                                    </ul>

                                    <div class="tab-content">
                                        {% for language in languages %}
                                            <div class="tab-pane" id="cart-language{{ language['language_id'] }}">
                                                <div class="form-group required">
                                                    <div class="col-sm-12">
                                                        <input type="text" name="kit_description[{{ language['language_id'] }}][cart_title]" value="{{ kit_description[language['language_id']] is defined ? kit_description[language['language_id']]['cart_title'] : '' }}" placeholder="{{ entry_name }}" id="input-title{{ language['language_id'] }}" class="form-control" />
                                                        {% if (error_name[language['language_id']] is defined) %}
                                                            <div class="text-danger hidden">{{ error_name[language['language_id']] }}</div>
                                                        {% endif %}
                                                    </div>
                                                </div>

                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>


                            <div class="form-group  {% if (not show_custom_field_text) %}hidden{% endif %}">
                                <label class="col-sm-2 control-label" for="custom_field_text">{{ text_custom_field_text }}</label>
                                <div class="col-sm-10">
                                    <input type="text" name="custom_field_text" value="{{ custom_field_text }}" placeholder="" id="custom_field_text" class="form-control" />
                                </div>
                            </div>

                            <div class="form-group {% if (not show_custom_field_string) %}hidden{% endif %}">
                                <label class="col-sm-2 control-label" for="custom_field_text">{{ text_custom_field_string }}</label>
                                <div class="col-sm-10">
                                    <input type="text" name="custom_field_string" value="{{ custom_field_string }}" placeholder="" id="custom_field_text" class="form-control" />
                                </div>
                            </div>
                            <div class="form-group {% if (not show_custom_field_number) %}hidden{% endif %}">
                                <label class="col-sm-2 control-label" for="custom_field_number">{{ text_custom_field_number }}</label>
                                <div class="col-sm-10">
                                    <input type="text" name="custom_field_number" value="{{ custom_field_number }}" placeholder="" id="custom_field_number" class="form-control" />
                                </div>
                            </div>


                        </div>
                        <div class="tab-pane active1 in fade1" id="tab-data">

                            <div class="form-group hidden1">
                                <label class="col-sm-2 control-label">{{ text_main_mode }}</label>
                                <div class="col-sm-2">
                                    <select name="main_mode" class="form-control" onchange="on_change_main_mode(this);" >
                                        <option value="kit">{{ text_main_mode_kit }}</option>
                                        <option value="series"  {% if (main_mode == "series") %} {{ 'selected="selected"' }}{% endif %} >{{ text_main_mode_series }}</option>
                                        <option value="collection"  {% if (main_mode == "collection") %} {{ 'selected="selected"' }}{% endif %} >{{ text_main_mode_collection }}</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-group" id="form-group-link-product">
                                <label class="col-sm-2 control-label" for="input-link-product"><span data-toggle="tooltip" title="{{ text_link_to_products }}">{{ text_link_to_products }}</span></label>
                                <div class="col-sm-10" id="kit-product-link" style="">
                                    <input type="text" name="link_product_name" value="" placeholder="{{ text_input_name }}" id="input-link-product" class="form-control" />
                                    <div id="link-product" class="well well-sm" style="height: 150px; overflow: auto;margin-bottom: 0">
                                        {% set row_link_product=0 %}
                                        {% for link_product in link_products %}
                                            <div id="link-product{{ row_link_product }}"><i class="fa fa-minus-circle"></i> {{ link_product['name'] }}
                                                <!--                                    <input type="hidden" name="link_product[-->{# echo $link_product['id']; #}<!--][id]" value="-->{# echo $link_product['id']; #}<!--" />-->
                                                <!--                                    <input type="hidden" name="link_product[-->{# echo $link_product['id']; #}<!--][kit_id]" value="-->{# echo $link_product['kit_id']; #}<!--" />-->
                                                <input type="hidden" name="link_product[{{ row_link_product }}][item_type]" value="{{ link_product['item_type'] }}" />
                                                <input type="hidden" name="link_product[{{ row_link_product }}][item_id]" value="{{ link_product['item_id'] }}" />
                                                <input type="hidden" name="link_product[{{ row_link_product }}][item_value]" value="{{ link_product['item_value'] }}" />

                                                <input type="hidden" name="link_product[{{ row_link_product }}][name]" value="{{ link_product['name'] }}" />
                                                <input type="hidden" name="link_product[{{ row_link_product }}][has_options]" value="{{ link_product['has_options'] }}" />
                                            </div>
                                            {% set row_link_product = row_link_product + 1 %}
                                        {% endfor %}
                                    </div>

                                    <div class="hide-for-series1" id="form-group-link-product-combine-mode">
                                        <div class="btn-group btn-group-sm" role="group" aria-label="...">
                                            {% for product_combine_mode_value_key,product_combine_mode_value in product_combine_mode_values %}
                                                <button type="button" data-key-value="{{ product_combine_mode_value_key }}" class="btn btn-default mode-{{ product_combine_mode_value_key }}" onclick="on_click_link_product_combine_mode(this);">{{ product_combine_mode_value }}</button>
                                            {% endfor %}
                                        </div>
                                        <div class="hidden">
                                            <select name="link_products_combine_mode" id="input-link-products-combine-mode" onchange="//update_items_empty_mode_info(this)" class="form-control" style="">
                                                {% for product_combine_mode_value_key,product_combine_mode_value in product_combine_mode_values %}
                                                    <option value="{{ product_combine_mode_value_key }}" {% if (product_combine_mode_value_key == link_products_combine_mode) %} {{ 'selected="selected"' }}{% endif %} >{{ product_combine_mode_value }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>

                                    <div class="kit-link-product-error-container"></div>
                                    {% if (error_link_product is defined) %}
                                        <div class="text-danger">{{ error_link_product }}</div>
                                    {% endif %}
                                </div>
                            </div>


                            <div class="form-group hide-for-series ">
                                <label class="col-sm-2 control-label">{{ text_kit_as_product }}</label>
                                <div class="col-sm-2">
                                    <select name="kit_as_product" class="form-control" onchange="on_change_kit_as_product_field();" >
                                        {% if (kit_as_product) %}
                                            <option value="1" selected="selected">{{ text_yes }}</option>
                                            <option value="0">{{ text_no }}</option>
                                        {% else %}
                                            <option value="1">{{ text_yes }}</option>
                                            <option value="0" selected="selected">{{ text_no }}</option>
                                        {% endif %}
                                    </select>
                                </div>
                            </div>

                            <div class="form-group kit-in-cart-as-product-container hide-for-series hidden">
                                <label class="col-sm-2 control-label">{{ text_kit_in_cart_as_product }}</label>
                                <div class="col-sm-2">
                                    <select name="kit_in_cart_as_product" class="form-control" >
                                        {% if (kit_in_cart_as_product) %}
                                            <option value="1" selected="selected">{{ text_yes }}</option>
                                            <option value="0">{{ text_no }}</option>
                                        {% else %}
                                            <option value="1">{{ text_yes }}</option>
                                            <option value="0" selected="selected">{{ text_no }}</option>
                                        {% endif %}
                                    </select>
                                </div>
                            </div>




                            <div class="form-group product-as-kit-light-mode-container hide-for-series ">
                                <label class="col-sm-2 control-label">{{ text_kit_as_product_light_mode }}</label>
                                <div class="col-sm-2">
                                    <select name="kit_as_product_light_mode" class="form-control" onchange="on_change_kit_as_product_field_light_mode();" >
                                        {% if (kit_as_product_light_mode) %}
                                            <option value="1" selected="selected">{{ text_yes }}</option>
                                            <option value="0">{{ text_no }}</option>
                                        {% else %}
                                            <option value="1">{{ text_yes }}</option>
                                            <option value="0" selected="selected">{{ text_no }}</option>
                                        {% endif %}
                                    </select>
                                </div>
                            </div>


                            <div class="form-group save-kit-as-product-total-container hide-for-series hidden">
                                <label class="col-sm-2 control-label">{{ text_save_kit_as_product_total }}</label>
                                <div class="col-sm-2">
                                    <select name="save_kit_as_product_total" class="form-control" onchange="update_price_rewrite();" >
                                        {% if (save_kit_as_product_total) %}
                                            <option value="1" selected="selected">{{ text_yes }}</option>
                                            <option value="0">{{ text_no }}</option>
                                        {% else %}
                                            <option value="1">{{ text_yes }}</option>
                                            <option value="0" selected="selected">{{ text_no }}</option>
                                        {% endif %}
                                    </select>
                                    <div id="text-warning-price-rewrite"><span style="color:red">*</span> {{ text_warning_price_rewrite }}</div>
                                </div>

                            </div>


                            <div class="form-group product-discount-in-total-container hide-for-series">
                                <label class="col-sm-2 control-label">{{ text_product_discount_in_total }}</label>
                                <div class="col-sm-2">
                                    <select name="product_discount_in_total" class="form-control" >
                                        {% if (product_discount_in_total) %}
                                            <option value="1" selected="selected">{{ text_yes }}</option>
                                            <option value="0">{{ text_no }}</option>
                                        {% else %}
                                            <option value="1">{{ text_yes }}</option>
                                            <option value="0" selected="selected">{{ text_no }}</option>
                                        {% endif %}
                                    </select>
                                </div>
                            </div>

                            <div class="form-group hide-for-series">
                                <label class="col-sm-2 control-label" for="input-kit-mode">{{ text_kit_price }}</label>
                                <div class="col-sm-4">
                                    <select name="kit_price_mode[mode]" id="input-kit-price-mode" class="form-control" onchange="update_kit_price_mode();">
                                        {% for index,value in kit_price_mode_list %}
                                            {% if (kit_price_mode['mode'] == index) %}
                                                <option value="{{ index }}" selected="selected">{{ value }}</option>
                                            {% else %}
                                                <option value="{{ index }}" >{{ value }}</option>
                                            {% endif %}
                                        {% endfor %}
                                    </select>
                                </div>

                                <div class="col-sm-2" id="kit-price-form-1" style="display: none">
                                </div>
                                <div class="col-sm-2" id="kit-price-form-2" style="display: none">
                                    <input type="text" name="kit_price_mode[sum_minus_percent]" value="{{ kit_price_mode['sum_minus_percent'] is defined ? kit_price_mode['sum_minus_percent'] : '0' }}" placeholder="{{ text_products_total_minus_percent }}" id="input-kit-price-percent; ?>" class="form-control" />
                                </div>
                                <div  class="col-sm-2" id="kit-price-form-3" style="display: none">
                                    <input type="text" name="kit_price_mode[sum_minus_value]" value="{{ kit_price_mode['sum_minus_value'] is defined ? kit_price_mode['sum_minus_value'] : '0' }}" placeholder="{{ text_products_total_minus_sum }}" id="input-kit-price-percent; ?>" class="form-control" />
                                </div>
                                <div  class="col-sm-2" id="kit-price-form-4" style="display: none">
                                    <input type="text" name="kit_price_mode[sum_fix]" value="{{ kit_price_mode['sum_fix'] is defined ? kit_price_mode['sum_fix'] : '0' }}" placeholder="{{ text_products_total_fixed }}" id="input-kit-price-percent; ?>" class="form-control" />
                                </div>
                            </div>

                            {#15911#}
                            <div class="form-group hide-for-series price-mode-to-customer-groups-content" style="border-top:unset;padding-top: 0; ">
                                <label class="col-sm-2 control-label" for="input-kit-mode"></label>
                                <div class="col-sm-4">
                                    <label>
                                        {% if kit_price_mode_to_customer_groups_status %}
                                            <input type="checkbox" name="kit_price_mode_to_customer_groups_status" checked value = "1" onchange="update_kit_price_mode_to_customer_groups_status(this);">
                                        {% else %}
                                            <input type="checkbox" name="kit_price_mode_to_customer_groups_status"  value = "1" onchange="update_kit_price_mode_to_customer_groups_status(this);">
                                        {% endif %}
                                        <span style="vertical-align: top;font-weight: normal">{{text_kit_price_mode_to_customer_groups_status}}</span>
                                    </label>
                                </div>
                            </div>


                            <div id="kit-price-mode-to-customer-groups" class="form-group hide-for-series price-mode-to-customer-groups-content" style="border-top:unset;padding-top: 0; ">
                                {% set kit_price_mode_to_customer_group_row = 0 %}
                                {% for kit_price_mode_to_customer_group in kit_price_mode_to_customer_groups  %}


                                    <div class="row kit-price-mode-to-customer-groups-row" style="margin-bottom:8px">
                                        <label class="col-sm-2"></label>
                                        <div class="col-sm-6 w">
                                            <div  class="col-sm-4 "  style="">
                                                <select name="kit_price_mode_to_customer_groups[{{ kit_price_mode_to_customer_group_row }}][customer_group_id]" class="form-control">
                                                    {% for customer_group in customer_groups  %}
                                                        {% if customer_group['customer_group_id'] == kit_price_mode_to_customer_group['customer_group_id'] %}
                                                            <option value="{{customer_group['customer_group_id']}}" selected="selected">{{customer_group['name']}}</option>
                                                        {% else %}
                                                            <option value="{{customer_group['customer_group_id']}}">{{customer_group['name']}}</option>
                                                        {% endif %}
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            <div class="col-sm-4">
                                                <select name="kit_price_mode_to_customer_groups[{{kit_price_mode_to_customer_group_row}}][kit_price_mode]" id="" class="form-control" onchange="">
                                                    {% for index, value in kit_price_mode_list  %}
                                                        {% if index == kit_price_mode_to_customer_group['kit_price_mode'] %}
                                                            <option value="{{index}}" selected="selected">{{value}}</option>
                                                        {% else %}
                                                            <option value="{{index}}" >{{value}}</option>
                                                        {% endif %}
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            <div class="col-sm-2"  style="">
                                                <input type="text" name="kit_price_mode_to_customer_groups[{{kit_price_mode_to_customer_group_row}}][value]" value="{{kit_price_mode_to_customer_group['value']}}" placeholder="" id="" class="form-control" />
                                            </div>
                                            <div class="col-sm-2"  style="">
                                                <a onclick="delete_kit_price_mode_to_customer_group_row(this);" title="" class="btn btn-default delete-button" style=""><i class="fa fa-minus-circle"></i></a>
                                            </div>
                                        </div>
                                        <div class="col-sm-4"></div>
                                    </div>
                                    {% set kit_price_mode_to_customer_group_row = kit_price_mode_to_customer_group_row + 1 %}
                                {% endfor %}

                                <div class="row kit-price-mode-to-customer-groups-row-add-button" style="">
                                    <label class="col-sm-2"></label>
                                    <div class="col-sm-6">
                                        <div class="col-sm-10 text-left">
                                            <a onclick="add_kit_price_mode_to_customer_group_row(this);" title="" class="btn btn-default " style=""><i class="fa fa-plus-circle"></i></a>
                                        </div>
                                        <div class="col-sm-2">
                                        </div>
                                    </div>
                                    <div class="col-sm-4 "></div>
                                </div>
                            </div>
                            {#15911#}

                            <div class="form-group hide-for-series" id="form-kit-discount-by-product-count">
                                <label class="col-sm-2 control-label" for="input-status">{{ text_kit_discount_by_product_count }}</label>
                                <div class="col-sm-2">
                                    <select name="kit_discount_by_product_count[status]" id="input-kit-discount-by-product-count-status" class="form-control" onchange="update_kit_discount_by_product_count();">
                                        {% if (kit_discount_by_product_count['status']) %}
                                            <option value="1" selected="selected">{{ text_yes }}</option>
                                            <option value="0">{{ text_no }}</option>
                                        {% else %}
                                            <option value="1">{{ text_yes }}</option>
                                            <option value="0" selected="selected">{{ text_no }}</option>
                                        {% endif %}
                                    </select>
                                </div>
                                <div class="col-sm-2" style="display: none" id="kit-discount-by-product-count-min">
                                    <input type="text" name="kit_discount_by_product_count[min]" value="{{ kit_discount_by_product_count['min'] is defined ? kit_discount_by_product_count['min'] : '' }}" placeholder="{{ text_product_quantity_limit_min }}" id="input-kit-discount-by-product-count-min" class="form-control" />
                                </div>
                                <div class="col-sm-2" style="display: none" id="kit-discount-by-product-count-max">
                                    <input type="text" name="kit_discount_by_product_count[max]" value="{{ kit_discount_by_product_count['max'] is defined ? kit_discount_by_product_count['max'] : '' }}" placeholder="{{ text_product_quantity_limit_max }}" id="input-kit-discount-by-product-count-max" class="form-control" />
                                </div>
                            </div>

                            <div class="form-group hide-for-series" id="form-bundle-total-price-hide-special">
                                <label class="col-sm-2 control-label">{{ text_bundle_total_price_hide_special }}</label>
                                <div class="col-sm-2">
                                    <select name="bundle_total_price_hide_special" class="form-control" >
                                        {% if (bundle_total_price_hide_special) %}
                                            <option value="1" selected="selected">{{ text_yes }}</option>
                                            <option value="0">{{ text_no }}</option>
                                        {% else %}
                                            <option value="1">{{ text_yes }}</option>
                                            <option value="0" selected="selected">{{ text_no }}</option>
                                        {% endif %}
                                    </select>
                                </div>
                            </div>

                            <div class="form-group hide-for-series" id="form-kit-as-product-main-product-use-default-discount">
                                <label class="col-sm-2 control-label">{{ text_kit_as_product_main_product_use_default_discount }}</label>
                                <div class="col-sm-2">
                                    <select name="kit_as_product_main_product_use_default_discount" class="form-control" >
                                        {% if (kit_as_product_main_product_use_default_discount) %}
                                            <option value="1" selected="selected">{{ text_yes }}</option>
                                            <option value="0">{{ text_no }}</option>
                                        {% else %}
                                            <option value="1">{{ text_yes }}</option>
                                            <option value="0" selected="selected">{{ text_no }}</option>
                                        {% endif %}
                                    </select>
                                </div>
                            </div>

                            <div class="form-group hide-for-series">
                                <label class="col-sm-2 control-label">{{ text_consider_discount }}</label>
                                <div class="col-sm-2">
                                    <select name="enable_discount" class="form-control" >
                                        {% if (enable_discount) %}
                                            <option value="1" selected="selected">{{ text_yes }}</option>
                                            <option value="0">{{ text_no }}</option>
                                        {% else %}
                                            <option value="1">{{ text_yes }}</option>
                                            <option value="0" selected="selected">{{ text_no }}</option>
                                        {% endif %}
                                    </select>
                                </div>
                            </div>
                            <div class="form-group hide-for-series">
                                <label class="col-sm-2 control-label">{{ text_consider_actions }}</label>
                                <div class="col-sm-2">
                                    <select name="enable_special" class="form-control"  onchange="update_specials_in_kit();">
                                        {% if (enable_special) %}
                                            <option value="1" selected="selected">{{ text_yes }}</option>
                                            <option value="0">{{ text_no }}</option>
                                        {% else %}
                                            <option value="1">{{ text_yes }}</option>
                                            <option value="0" selected="selected">{{ text_no }}</option>
                                        {% endif %}
                                    </select>
                                </div>
                            </div>
                            <div class="form-group hide-for-series show-default-specials-in-kit-discounts-container">
                                <label class="col-sm-2 control-label">{{ text_show_default_specials_in_kit_discounts }}</label>
                                <div class="col-sm-2">
                                    <select name="show_default_specials_in_kit_discounts" class="form-control" >
                                        {% if (show_default_specials_in_kit_discounts) %}
                                            <option value="1" selected="selected">{{ text_yes }}</option>
                                            <option value="0">{{ text_no }}</option>
                                        {% else %}
                                            <option value="1">{{ text_yes }}</option>
                                            <option value="0" selected="selected">{{ text_no }}</option>
                                        {% endif %}
                                    </select>
                                </div>
                            </div>
                            <div class="form-group hide-for-series auto-kit-in-cart">
                                <label class="col-sm-2 control-label">{{ text_auto_kit_in_cart }}</label>
                                <div class="col-sm-2">
                                    <select name="auto_kit_in_cart" class="form-control" >
                                        {% if (auto_kit_in_cart) %}
                                            <option value="1" selected="selected">{{ text_yes }}</option>
                                            <option value="0">{{ text_no }}</option>
                                        {% else %}
                                            <option value="1">{{ text_yes }}</option>
                                            <option value="0" selected="selected">{{ text_no }}</option>
                                        {% endif %}
                                    </select>
                                </div>
                            </div>
                            <div class="form-group hide-for-series add-to-cart-mode">
                                <label class="col-sm-2 control-label">{{ text_add_to_cart_mode }}</label>
                                <div class="col-sm-2">
                                    <select name="add_to_cart_mode" class="form-control"" >
                                    {% if (add_to_cart_mode == 'bundle') %}
                                        <option value="bundle" selected="selected">{{ text_add_to_cart_mode_bundle }}</option>
                                        <option value="simple_products">{{ text_add_to_cart_mode_simple_products }}</option>
                                    {% else %}
                                        <option value="bundle">{{ text_add_to_cart_mode_bundle }}</option>
                                        <option value="simple_products" selected="selected">{{ text_add_to_cart_mode_simple_products }}</option>
                                    {% endif %}
                                    </select>
                                </div>
                            </div>
                            <div class="form-group hidden">
                                <label class="col-sm-2 control-label">{{ 'Учитывать текущие остатки' }}</label>
                                <div class="col-sm-2">
                                    <select name="quantity_control" class="form-control" >
                                        {% if (quantity_control) %}
                                            <option value="1" selected="selected">{{ text_yes }}</option>
                                            <option value="0">{{ text_no }}</option>
                                        {% else %}
                                            <option value="1">{{ text_yes }}</option>
                                            <option value="0" selected="selected">{{ text_no }}</option>
                                        {% endif %}
                                    </select>


                                </div>
                            </div>

                            <div class="form-group hide-for-series">
                                <label class="col-sm-2 control-label" for="input-status">{{ text_product_quantity_limit }}</label>
                                <div class="col-sm-2">
                                    <select name="product_quantity_limit[status]" id="input-product-quantity-limit-status" class="form-control" onchange="update_views();">
                                        {% if (product_quantity_limit['status']) %}
                                            <option value="1" selected="selected">{{ text_yes }}</option>
                                            <option value="0">{{ text_no }}</option>
                                        {% else %}
                                            <option value="1">{{ text_yes }}</option>
                                            <option value="0" selected="selected">{{ text_no }}</option>
                                        {% endif %}
                                    </select>
                                </div>
                                <div class="col-sm-2" style="display: none" id="product-quantity-limit-min">
                                    <input type="text" name="product_quantity_limit[min]" value="{{ product_quantity_limit['min'] is defined ? product_quantity_limit['min'] : '' }}" placeholder="{{ text_product_quantity_limit_min }}" id="input-product-quantity-limit-min" class="form-control" />
                                </div>
                                <div class="col-sm-2" style="display: none" id="product-quantity-limit-max">
                                    <input type="text" name="product_quantity_limit[max]" value="{{ product_quantity_limit['max'] is defined ? product_quantity_limit['max'] : '' }}" placeholder="{{ text_product_quantity_limit_max }}" id="input-product-quantity-limit-max" class="form-control" />
                                </div>
                            </div>

                            <div class="form-group  hide-for-series">
                                <label class="col-sm-2 control-label">{{ text_disbanded_bundle_clear }}</label>
                                <div class="col-sm-2">
                                    <select name="disbanded_bundle_clear" class="form-control" >
                                        {% if (disbanded_bundle_clear) %}
                                            <option value="1" selected="selected">{{ text_yes }}</option>
                                            <option value="0">{{ text_no }}</option>
                                        {% else %}
                                            <option value="1">{{ text_yes }}</option>
                                            <option value="0" selected="selected">{{ text_no }}</option>
                                        {% endif %}
                                    </select>


                                </div>
                            </div>

                            <div class="form-group hide-for-series">
                                <label class="col-sm-2 control-label" for="input-status">{{ text_limit_kit_count }}</label>
                                <div class="col-sm-2">
                                    <select name="kit_quantity_mode[limit]" id="input-kit-quantity-mode" class="form-control" onchange="update_views();">
                                        {% if (kit_quantity_mode['limit']) %}
                                            <option value="1" selected="selected">{{ text_yes }}</option>
                                            <option value="0">{{ text_no }}</option>
                                        {% else %}
                                            <option value="1">{{ text_yes }}</option>
                                            <option value="0" selected="selected">{{ text_no }}</option>
                                        {% endif %}
                                    </select>
                                </div>
                                <div class="col-sm-2" style="display: none" id="kit-quantity-form">
                                    <input type="text" name="kit_quantity_mode[value]" value="{{ kit_quantity_mode['value'] is defined ? kit_quantity_mode['value'] : '0' }}" placeholder="{{ text_kit_count }}" id="input-kit-quantity-mode-value" class="form-control" />
                                </div>
                            </div>

                            <div class="form-group hide-for-series">
                                <label class="col-sm-2 control-label" for="input-status">{{ text_limit_kit_in_cart }}</label>
                                <div class="col-sm-2">
                                    <select name="kit_cart_limit_mode[limit]" id="input-kit-cart-limit-mode" class="form-control" onchange="update_views();">
                                        {% if (kit_cart_limit_mode['limit']) %}
                                            <option value="1" selected="selected">{{ text_yes }}</option>
                                            <option value="0">{{ text_no }}</option>
                                        {% else %}
                                            <option value="1">{{ text_yes }}</option>
                                            <option value="0" selected="selected">{{ text_no }}</option>
                                        {% endif %}
                                    </select>
                                </div>
                                <div class="col-sm-2" style="display: none" id="kit-cart-limit-form">
                                    <input type="text" name="kit_cart_limit_mode[value]" value="{{ kit_cart_limit_mode['value'] is defined ? kit_cart_limit_mode['value'] : '0' }}" placeholder="{{ text_kit_count_in_cart }}" id="input-kit-quantity-mode-value" class="form-control" />
                                </div>
                            </div>

                            <div class="form-group hide-for-series11 hide-for-kits">
                                <label class="col-sm-2 control-label" for="input-series-mode">{{ text_series_mode }}</label>
                                <div class="col-sm-4">
                                    <select name="series_mode" id="input-series-mode" class="form-control" onchange="">
                                        {% for index,value in series_mode_values %}
                                            {% if (series_mode == index) %}
                                                <option value="{{ index }}" selected="selected">{{ value }}</option>
                                            {% else %}
                                                <option value="{{ index }}" >{{ value }}</option>
                                            {% endif %}
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>

                            <div class="form-group hide-for-series">
                                <label class="col-sm-2 control-label">{{ entry_image }}</label>
                                <div class="col-sm-10"><a href="" id="thumb-image" data-toggle="image" class="img-thumbnail"><img src="{{ thumb }}" alt="" title="" data-placeholder="{{ placeholder }}" /></a>
                                    <input type="hidden" name="image" value="{{ image }}" id="input-image" />
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-2 control-label" for="input-sort-order">{{ entry_sort_order }}</label>
                                <div class="col-sm-10">
                                    <input type="text" name="sort_order" value="{{ sort_order }}" placeholder="{{ entry_sort_order }}" id="input-sort-order" class="form-control" />
                                </div>
                            </div>




                            <div class="form-group">
                                <label class="col-sm-2 control-label" for="input-status">{{ entry_status }}</label>
                                <div class="col-sm-10">
                                    <select name="status" id="input-status" class="form-control">
                                        {% if (status) %}
                                            <option value="1" selected="selected">{{ text_enabled }}</option>
                                            <option value="0">{{ text_disabled }}</option>
                                        {% else %}
                                            <option value="1">{{ text_enabled }}</option>
                                            <option value="0" selected="selected">{{ text_disabled }}</option>
                                        {% endif %}
                                    </select>
                                </div>
                            </div>
                        </div>


                        <div class="tab-pane active1 in fade1" id="tab-product">

                            <div class="form-group hide-for-import-mode1">
                                <label class="col-sm-2 control-label" for="input-kit-mode"><span data-toggle="tooltip" title="{{ text_kit_type }}">{{ text_kit_type }}</label>
                                <div class="col-sm-10">
                                    <select name="kit_mode" id="input-kit-mode" class="form-control" onchange="update_main_products();">
{#                                        <!--15913-->#}
                                        {% for kit_modes_item in kit_modes_list %}
                                        <?php foreach ($kit_modes_list as $kit_modes_item) {?>
                                        <option value="{{ kit_modes_item['code'] }}" {% if kit_mode == kit_modes_item['code'] %}  selected="selected" {% endif %}>{{kit_modes_item['title']}}</option>
                                        {% endfor %}
{#                                        <!--15913-->#}
                                    </select>
                                </div>

                            </div>

{#                            <!--15913-->#}
                            <div class="form-group hide-for-import-mode1" id="form-group-auto-list-grouping">
                                <label class="col-sm-2 control-label" for="input-kit-mode"><span data-toggle="tooltip" title="{{ text_kit_mode_auto_list_grouping }}">{{ text_kit_mode_auto_list_grouping }}</label>
                                <div class="col-sm-10">
                                    <select name="kit_mode_auto_list_grouping" id="input-auto-list-grouping" class="form-control" onchange="update_main_products();">
                                        {% for grouping_item in kit_mode_auto_list_grouping_items %}
                                        <option value="{{ grouping_item['code']  }}" {% if kit_mode_auto_list_grouping == grouping_item['code'] %}  selected="selected" {% endif %}>{{ grouping_item['title'] }}</option>
                                        {% endfor %}
                                    </select>
                                </div>

                            </div>
{#                            <!--15913--#}

                            <div class="form-group hide-for-series" id="form-group-main-product">
                                <label class="col-sm-2 control-label" for="input-main-product"><span data-toggle="tooltip" title="{{ text_main_product }}">{{ text_main_product }}</span></label>
                                <div class="col-sm-10" id="kit-product-main" style="">
                                    <div div-unique-id="f0efeaf12283452e447"></div>
                                    <table id="kit-main-product-list" class="table table-striped table-bordered table-hover">
                                        <thead>
                                        <tr>
                                            <td class="text-center ">{{ '№' }}</td>
                                            <td class="text-left ">{{ text_product }}</td>
                                            <td class="text-left ">{{ text_options }}</td>
                                            <td class="text-left ">{{ text_quantity }}</td>
                                            <td class="text-left ">{{ text_price }}</td>
                                            <td class="text-left list-product-custom-field-form">{{ text_custom_field }}</td>
                                        </tr>
                                        </thead>
                                        <tbody id="kit-product-main-content" class="form-group-main-product">

                                        </tbody>

                                        <tfoot>


                                        </tfoot>
                                    </table>


                                </div>
                            </div>


                            <div class="form-group" id="form-group-kit-product">
                                <label class="col-sm-2 control-label" for="input-list-product"><span data-toggle="tooltip" title="{{ text_kit_products }}">{{ text_kit_products }}</span></label>

                                <div class="col-sm-10"  style="">
                                    <div div-unique-id="6aaadbf48e04015c559d7"></div>
                                    <table id="kit-product-list" class="table table-striped table-bordered table-hover">
                                        <thead>
                                        <tr>
                                            <td class="text-center hide-for-series ">{{ '№' }}</td>
                                            <td class="text-left">{{ text_product_select_mode }}</td>
                                            <td class="text-left">{{ text_product }}</td>
                                            <td class="text-left hide-for-series">{{ text_options }}</td>
                                            <td class="text-left hide-for-series">{{ text_quantity }}</td>
                                            <td class="text-left hide-for-series">{{ text_price }}</td>
                                            <td class="text-left hide-for-series list-product-custom-field-form">{{ text_custom_field }}</td>
                                            <td class="text-left"></td>
                                        </tr>
                                        </thead>

                                        <tbody id="kit-product-list-content">

                                        </tbody>
                                        <tfoot>

                                        <tr >
                                            <td colspan="2"></td>
                                            {% set col_span = 4 %}
                                            {% if (not hide_list_product_custom_field) %}{% set col_span = col_span + 1 %}{% endif %}

                                            <td colspan="{{ col_span }}" class="hide-for-series"></td>
                                            <td class="text-right"><a onclick="add_new_product();" title="" class="btn btn-primary" style=""><i class="fa fa-plus-circle"></i></a></td>

                                        </tr>
                                        </tfoot>
                                    </table>

                                </div>
                            </div>




                        </div>


                        {% if (groups_enable) %}
                            <div class="tab-pane active1 in fade1" id="tab-groups">
                                {{ groups_tab_html }}
                            </div>
                        {% endif %}

                        <div class="tab-pane active1 in fade1" id="tab-widget">
                            <fieldset>

                                <legend style="border-bottom: none">{{ text_widgets_with_kit }}</legend>
                                <table id="kit-widgets" class="table table-striped table-bordered table-hover">
                                    <thead>
                                    <tr>
                                        <td class="text-left">{{ text_widget_name }}</td>
                                        <td class="text-right"></td>
                                        <td></td>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    {% set kit_widget_row = 0 %}
                                    {% for kit_widget in kit_widgets %}
                                        <tr id="kit-widget-row{{ kit_widget_row }}">
                                            <td class="text-left">
                                                <input type="hidden" name="kit_widgets[{{ kit_widget_row }}][widget_id]" value="{{ kit_widget['widget_id'] }}" class="form-control input-widget-id" />
                                                <input type="text" name="kit_widgets[{{ kit_widget_row }}][name]" value="{{ kit_widget['name'] is defined ? kit_widget['name'] : '' }}" placeholder="{{ text_widget }}" class="form-control input-widget-name" />
                                            </td>


                                            <td class="text-right">
                                                <a href="{{ kit_widget['href'] }}" data-toggle="tooltip" title="{{ '' }}" class="btn btn-default input-widget-href"><i class="fa fa-pencil"></i></a>
                                            </td>
                                            <td class="text-right">
                                                <button type="button" onclick="$('#kit-widget-row{{ kit_widget_row }}').remove();" data-toggle="tooltip" title="{{ button_remove }}" class="btn btn-danger"><i class="fa fa-minus-circle"></i></button>
                                            </td>

                                        </tr>
                                        {% set kit_widget_row = kit_widget_row + 1 %}
                                    {% endfor %}
                                    {% if (kit_widgets is empty) %}
                                        <tr id="widget-kit-row{{ kit_widget_row }}">
                                            <td colspan="3" class="text-left" style="vertical-align: middle">
                                                {{ text_kit_no_has_widgets }}
                                            </td>
                                        </tr>
                                    {% endif %}
                                    </tbody>
                                    <tfoot>
                                    <tr class="">
                                        <td colspan="2"></td>
                                        <td class="text-right">
                                            <button type="button" onclick="addKitWidget();" data-toggle="tooltip" title="{{ '' }}" class="btn btn-primary"><i class="fa fa-plus-circle"></i></button>
                                        </td>
                                    </tr>
                                    </tfoot>
                                </table>
                            </fieldset>
                        </div>

                        <div class="tab-pane" id="tab-kit-period">
                            <div class="table-responsive">
                                <table id="kit-period" class="table table-striped table-bordered table-hover">
                                    <thead>
                                    <tr>
                                        <td class="text-left">{{ entry_customer_group }}</td>
                                        <td class="text-right">{{ entry_priority }}</td>
                                        <td class="text-left">{{ entry_date_start }}</td>
                                        <td class="text-left">{{ entry_date_end }}</td>
                                        <td></td>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    {% set kit_period_row = 0 %}
                                    {% for kit_period in kit_periods %}
                                        <tr id="special-row{{ kit_period_row }}">
                                            <td class="text-left"><select name="kit_period[{{ kit_period_row }}][customer_group_id]" class="form-control">
                                                    {% for customer_group in customer_groups %}
                                                        {% if (customer_group['customer_group_id'] == kit_period['customer_group_id']) %}
                                                            <option value="{{ customer_group['customer_group_id'] }}" selected="selected">{{ customer_group['name'] }}</option>
                                                        {% else %}
                                                            <option value="{{ customer_group['customer_group_id'] }}">{{ customer_group['name'] }}</option>
                                                        {% endif %}
                                                    {% endfor %}
                                                </select></td>
                                            <td class="text-right"><input type="text" name="kit_period[{{ kit_period_row }}][priority]" value="{{ kit_period['priority'] }}" placeholder="{{ entry_priority }}" class="form-control" /></td>
                                            <td class="text-left" style="width: 20%;"><div class="input-group date">
                                                    <input type="text" name="kit_period[{{ kit_period_row }}][date_start]" value="{{ kit_period['date_start'] }}" placeholder="{{ entry_date_start }}" data-date-format="YYYY-MM-DD" class="form-control" />
                                                    <span class="input-group-btn">
                          <button class="btn btn-default" type="button"><i class="fa fa-calendar"></i></button>
                          </span></div></td>
                                            <td class="text-left" style="width: 20%;"><div class="input-group date">
                                                    <input type="text" name="kit_period[{{ kit_period_row }}][date_end]" value="{{ kit_period['date_end'] }}" placeholder="{{ entry_date_end }}" data-date-format="YYYY-MM-DD" class="form-control" />
                                                    <span class="input-group-btn">
                          <button class="btn btn-default" type="button"><i class="fa fa-calendar"></i></button>
                          </span></div></td>
                                            <td class="text-left"><button type="button" onclick="$('#special-row{{ kit_period_row }}').remove();" data-toggle="tooltip" title="{{ button_remove }}" class="btn btn-danger"><i class="fa fa-minus-circle"></i></button></td>
                                        </tr>
                                        {% set kit_period_row = kit_period_row + 1 %}
                                    {% endfor %}
                                    </tbody>
                                    <tfoot>
                                    <tr>
                                        <td colspan="4"></td>
                                        <td class="text-left"><button type="button" onclick="addKitPeriod();" data-toggle="tooltip" title="{{ button_kit_period_add }}" class="btn btn-primary"><i class="fa fa-plus-circle"></i></button></td>
                                    </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>


                        <div class="tab-pane active1 in fade1 hide-for-series" id="tab-log">
                            <fieldset>

                                <legend style="border-bottom: none">{{ text_kit_log_description }}</legend>

                                {% for kit_history in kit_history_status %}
                                    {% if (kit_history['status'] == 'success') %}
                                        <i class="fa fa-check-circle"></i>
                                    {% else %}
                                        <i class="fa fa-exclamation-triangle"></i>
                                    {% endif %}
                                    {{ kit_history['text'] }}
                                    <br>
                                {% endfor %}

                            </fieldset>
                        </div>

                    </div>
                </form>
            </div>
        </div>
    </div>


    <table >
        <tbody>
        <!--Product row template-->
        <tr id="kit-product-list-template" item-position="" row-index="" item-id="" style="display: none">


            <td class="column-position text-center hide-for-series" style="padding-top: 16px;">
                <span class="item-position-container"></span>

            </td>

            <td class="text-left column-item-mode">
                <select be_input_name="list_product[index][item_mode]" id="input-list-product-item-mode" onchange="on_item_mode_changed(this)" class="form-control" style="">
                    <option value="fix_product" selected="selected">{{ kit_product_item_mode['fix_product'] }}</option>
                    <option value="select_product">{{ kit_product_item_mode['select_product'] }}</option>
                    <option value="free_product">{{ kit_product_item_mode['free_product'] }}</option>
                </select>
                <div class="select-product-empty-mode-form  hide-for-series1" style="    padding-left: 8px;">
                    <div class="checkbox">
                        <label class=" hide-for-series">
                            <input type="checkbox" be_input_name="list_product[index][item_empty_mode][enable]" id="input-list-product-item-empty-mode-enable" value="0"  onchange="on_change_item_empty_mode(this)"/>
                            <span style="vertical-align: top">{{ select_product_empty_mode }}</span>
                        </label>
                        <a class="btn btn-default btn-xs" id="item-empty-mode-setting-button" onclick="toggle_setting_form(this, $(this).closest('.select-product-empty-mode-form'));" setting-form-id="select-product-empty-mode-form-container" title=""  style="vertical-align: top;margin-top: -1px;"><i class="fa fa-cog"></i></a>
                        <div class="select-product-empty-mode-form-container" style="display: none;margin-top: 8px">
                            <label style="display: block" class=" hide-for-series">
                                <input type="checkbox" be_input_name="list_product[index][item_empty_mode][default_empty]" id="input-list-product-item-empty-mode-default-empty" value="0" onchange="" />
                                <span style="vertical-align: top">{{ select_product_empty_default }}</span>
                            </label>
                            <label style="" class=" hide-for-series">
                                <input type="checkbox" be_input_name="list_product[index][item_empty_mode][not_empty_in_cart]" id="input-list-product-item-empty-mode-not-empty-in-cart" value="0" onchange="" />
                                <span style="vertical-align: top">{{ text_select_product_not_empty_in_cart }}</span>
                            </label>
                            <div style="margin-top: 8px;">
                                {% for language in languages %}
                                    <div class="col-sm-122" style="margin-bottom: 4px">
                                        <img src="{{ language['image_url'] }}" title="{{ language['name'] }}" />
                                        <input type="text" be_input_name="list_product[index][item_empty_mode][title][{{ language['language_id'] }}]" value="" placeholder="{{ entry_group_name }}" id="input-list-product-item-empty-mode-title{{ language['language_id'] }}" language-id="{{ language['language_id'] }}" class="form-control" style="width: auto;display: inline-block;margin-left: 8px"  onchange="update_items_empty_mode_info()" />
                                    </div>
                                {% endfor %}
                            </div>

                        </div>

                    </div>
                </div>
                <div class="select-product-hide-special-products-form hide-for-series" style="    padding-left: 8px;">
                    <div class="checkbox">
                        <label class="hide-for-series">
                            <input type="checkbox" be_input_name="list_product[index][hide_special_products]" id="input-list-product-item-hide-special-products" value="0"  onchange="update_items_empty_mode_info();"/>
                            <span style="vertical-align: top">{{ text_hide_special_products }}</span>
                        </label>
                    </div>
                </div>

                <div class="select-product-products-randomize-select-product-form hide-for-series" style="    padding-left: 8px;">
                    <div class="checkbox">
                        <label class="hide-for-series">
                            <input type="checkbox" be_input_name="list_product[index][randomize_select_product]" id="input-list-product-item-products-randomize-select-product" value="0"  onchange="update_items_empty_mode_info();"/>
                            <span style="vertical-align: top">{{ text_randomize_select_product }}</span>
                        </label>
                    </div>
                </div>

                <div class="select-product-products-combine-mode-form" style="    padding-left: 8px;">
                    <div class="hide-for-series1">
                        <div class="btn-group btn-group-sm" role="group" aria-label="...">
                            {% for product_combine_mode_value_key,product_combine_mode_value in product_combine_mode_values %}
                                <button type="button" data-key-value="{{ product_combine_mode_value_key }}" class="btn btn-default mode-{{ product_combine_mode_value_key }}" onclick="on_click_product_combine_mode(this);">{{ product_combine_mode_value }}</button>
                            {% endfor %}
                        </div>
                        <div class="hidden">
                            <select be_input_name="list_product[index][products_combine_mode]" id="input-list-product-item-products-combine-mode" onchange="update_items_empty_mode_info(this)" class="form-control" style="">
                                {% for product_combine_mode_value_key,product_combine_mode_value in product_combine_mode_values %}
                                    <option value="{{ product_combine_mode_value_key }}">{{ product_combine_mode_value }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>

                <div class="select-product-empty-group-image-form" style="    padding-left: 8px;margin-top: 8px">
                    <a href="" id="empty-group-image-thumb" data-toggle="image" class="img-thumbnail"><img src="{{ placeholder }}" alt="" title="" data-placeholder="{{ placeholder }}" /></a>
                    <input type="hidden" be_input_name="list_product[index][empty_group_image]" value="" id="input-list-product-empty-group-image"  />
                </div>



            </td>

            <td class="text-left column-filter-name">
                <input type="text" be_input_name="list_product[index][filter_name]" value="" placeholder="{{ text_input_name }}" id="input-list-product-name-filter" class="form-control" />
                <input type="hidden" be_input_name="list_product[index][item_position]" value="" id="input-list-product-item-position" class="form-control" />
                <input type="hidden" be_input_name="list_product[index][name]" value="" id="input-list-product-name" class="form-control" />
                <input type="hidden" be_input_name="list_product[index][item_id]" value="" id="input-list-product-item-id" class="form-control" />
                <input type="hidden" be_input_name="list_product[index][item_value]" value="" id="input-list-product-item-value" class="form-control" />
                <input type="hidden" be_input_name="list_product[index][item_type]" value="" id="input-list-product-item-type" class="form-control" />
                <input type="hidden" be_input_name="list_product[index][main]" value="" id="input-list-product-main" class="form-control" />
                <input type="hidden" be_input_name="list_product[index][has_options]" value="" id="input-list-product-has-options" class="form-control" />
                <input type="hidden" be_input_name="list_product[index][remove_item_product]" value="0" id="input-list-product-remove-item-product" class="form-control" />

                <div style="display: none" class="container-free-product-default-in-kit hide-for-series">
                    <label style="font-weight: normal; margin-top: 8px;">
                        <input type="checkbox" be_input_name="list_product[index][free_product_default_in_kit]" id="input-list-product-item-free-product-default-in-kit" value="0"/>
                        <span style="vertical-align: top">{{ text_free_product_default_in_kit }}</span>
                    </label>
                </div>

                <div class="setting-form-options-info" style="display:none;padding-left: 16px; color: rgba(0,0,0,0.4);margin-top: 4px;font-size: 11px">
                    <div class="options-info-enabled" id="" style="">
                        <div style="">{{ text_enabled_options }}&nbsp<span class="options-info-enabled-string"></span></div>
                    </div>
                    <div class="options-info-disabled" id="" style="">
                        <div style="">{{ text_disabled_options }}&nbsp<span class="options-info-disabled-string"></span></div>
                    </div>
                    <div class="options-info-fixed" id="" style="">
                        <div style="">{{ text_fixed_options }}&nbsp<span class="options-info-fixed-string"></span></div>
                    </div>
                </div>

                <div class="setting-form-options" style="display: none">
                    <div class="" id="" style="">
                        <div style="margin-top: 8px">{{ text_enabled_options }} </div>
                        <input type="text" be_input_name="enabled_options" value="" placeholder="{{ text_input_enabled_option_name }}" id="input-enabled-options" class="form-control" style="margin-top: 4px;" />
                        <div id="enabled-options" class="well well-sm" style="height: 150px; overflow: auto;" last-index="">
                        </div>
                    </div>
                    <div class="" id="" style="">
                        <div style="margin-top: 8px">{{ text_disabled_options }} </div>
                        <input type="text" be_input_name="disable_options" value="" placeholder="{{ text_input_disable_option_name }}" id="input-disable-options" class="form-control" style="margin-top: 4px;" />
                        <div id="disable-options" class="well well-sm" style="height: 150px; overflow: auto;" last-index="">
                        </div>
                    </div>
                    <div class="" id="" style="">
                        <div style="margin-top: 8px">{{ text_fixed_options }} </div>
                        <input type="text" be_input_name="fixed_options" value="" placeholder="{{ text_input_fixed_option_name }}" id="input-fixed-options" class="form-control" style="margin-top: 4px;" />
                        <div id="fixed-options" class="well well-sm" style="height: 150px; overflow: auto;" last-index="">
                        </div>
                    </div>
                </div>


            </td>
            <td class="text-left hide-for-series">
                <a class="btn btn-default options-button" onclick="toggle_setting_form(this, $(this).closest('.kit-product-list-item'));" setting-form-id="setting-form-options" title=""  style=""><i class="fa fa-cog"></i></a>
            </td>

            <td class="text-left hide-for-series">
                <input type="text" be_input_name="list_product[index][quantity]" value="" placeholder="{{ 'Количество' }}" id="input-list-product-quantity" class="form-control" />

                <div class="checkbox">

                    <label>
                        <input type="checkbox" be_input_name="list_product[index][quantity_edit]" id="input-list-product-item-quantity-edit" value="0"/>
                        <span style="vertical-align: top">{{ quantity_edit_enable }}</span>
                    </label>


                </div>
            </td>
            <td class="text-left hide-for-series">
                <select be_input_name="list_product[index][price_mode]" id="input-list-product-price-mode" onchange="update_views()" class="form-control">
                    <option value="product_price" selected="selected">{{ kit_product_price_mode['product_price'] }}</option>
                    <option value="product_price_minus_sum" selected="selected">{{ kit_product_price_mode['product_price_minus_sum'] }}</option>
                    <option value="product_price_minus_percent" selected="selected">{{ kit_product_price_mode['product_price_minus_percent'] }}</option>
                    <option value="fix_price">{{ kit_product_price_mode['fix_price'] }}</option>
                </select>
                <input type="text" be_input_name="list_product[index][price_minus_sum]" value="" placeholder="{{ text_minus_value }}" id="input-list-product-price-minus-sum" class="form-control" style="margin-top: 8px;" />
                <input type="text" be_input_name="list_product[index][price_minus_percent]" value="" placeholder="{{ text_minus_percent }}" id="input-list-product-price-minus-percent" class="form-control" style="margin-top: 8px;" />
                <input type="text" be_input_name="list_product[index][price]" value="" placeholder="{{ text_price }}" id="input-list-product-price" class="form-control" style="margin-top: 8px;" />

                {#15911#}
                <div style="margin-top: 8px; " class="price-mode-to-customer-groups-content">
                    <label>
                        <input type="checkbox" be_input_name="list_product[index][price_mode_to_customer_groups_status]"  id="input-list-product-item-products-price-mode-to-customer-groups-status" onchange="update_price_mode_to_customer_groups_status(this);" style="font-weight: normal; vertical-align: middle">
                        <span style="vertical-align: top;font-weight: normal">{{text_price_mode_to_customer_groups_status}}</span>
                    </label>
                </div>
                <div class="price-mode-to-customer-groups-container price-mode-to-customer-groups-content" rows-count="0">

                    <a onclick="add_price_mode_to_customer_group_row(this);" title="" class="price-mode-to-customer-group-add-button btn btn-default " style=""><i class="fa fa-plus-circle"></i></a>
                </div>
                {#15911#}

            </td>
            <td class="text-left hide-for-series list-product-custom-field-form">
                <input type="text" be_input_name="list_product[index][custom_field]" value="" placeholder="{{ text_custom_field }}" id="input-list-product-custom-field" class="form-control" style="" />
            </td>
            <td class="text-right column-delete-buttons">
                <a onclick="delete_product(this);" title="{{ '' }}" class="btn btn-danger delete-button" style=""><i class="fa fa-minus-circle"></i></a>
                <span class="item-position-arrows top-item" style="margin-top: 8px; display: block;">
                        <a class="btn btn-default btn-sm" style="" onclick="move_up(this);"><i class="fa fa-angle-double-up"></i></a>
                        <div></div>
                        <a class="btn btn-default btn-sm" style="" onclick="move_down(this);"><i class="fa fa-angle-double-down"></i></a>
                    </span>
                <span class="item-position-arrows child-item" style="margin-top: 8px; display: block;">
                        <a class="btn btn-default btn-sm" style="" onclick="move_up(this);"><i class="fa fa-angle-up"></i></a>
                        <div></div>
                        <a class="btn btn-default btn-sm" style="" onclick="move_down(this);"><i class="fa fa-angle-down"></i></a>
                    </span>

            </td>
        </tr>
        <!--Product row template-->

        <!--Product row add button template-->
        <tr id="select-product-add-button-template" class="hide-for-import-template"  item-id="" style="margin-top: 8px; display: none" item-mode="">
            <td colspan="" class="hide-for-series"></td>
            {% set col_span = 2 %}
            {% if (not hide_list_product_custom_field) %}{% set col_span = col_span + 1 %}{% endif %}

            <td colspan="{{ col_span }}" class="text-right hide-for-kits" style="">
                <a item-position="" onclick="add_new_product_select($(this).attr('item-position'), $(this).closest('tr').attr('item-mode'));" title="{{ '' }}" class="btn btn-success select-product-add-button" style=""><i class="fa fa-plus"></i></a>
            </td>
            {% set col_span = 5 %}
            {% if (not hide_list_product_custom_field) %}{% set col_span = col_span + 1 %}{% endif %}

            <td colspan="{{ col_span }}" class="text-right hide-for-series" style="">
                <a item-position="" onclick="add_new_product_select($(this).attr('item-position'), $(this).closest('tr').attr('item-mode'));" title="{{ '' }}" class="btn btn-success select-product-add-button" style=""><i class="fa fa-plus"></i></a>
            </td>
            <td colspan="" class="hi"></td>
        </tr>
        <!--Product row add button template-->

        {#15911#}
        <!--Product row price mode to customer groups template-->
        <div id="price-mode-to-customer-groups-row-template" >
            <div class="hidden price-mode-to-customer-groups-row" style="border-top:unset;padding-top: 0; ">
                <select be_input_name="list_product[index][price_mode_to_customer_groups][customer_group_id]" id="input-list-product-item-products-price-mode-to-customer-groups-customer-group-id" class="form-control">
                    {% for customer_group in customer_groups %}
                        <option value="{{ customer_group['customer_group_id'] }}">{{customer_group['name']}}</option>                <?php } ?>
                    {% endfor %}
                </select>
                <select be_input_name="list_product[index][price_mode_to_customer_groups][price_mode]" id="input-list-product-item-products-price-mode-to-customer-groups-price-mode" class="form-control" onchange="">
                    {% for index, value in kit_product_price_mode %}
                        <option value="{{index}}">{{value}}</option>
                    {% endfor %}
                </select>
                <input type="text" be_input_name="list_product[index][price_mode_to_customer_groups][value]" id="input-list-product-item-products-price-mode-to-customer-groups-value" class="form-control">
                <a onclick="delete_price_mode_to_customer_group_row(this);" title="" class="btn btn-default delete-button" style=""><i class="fa fa-minus-circle"></i></a>
            </div>
        </div>
        <!--Product row add button template-->
        {#15911#}

        </tbody>
    </table>

    <div style="display: none">
        <div class="dropdown-list-template">
            <div class="dropdown-template">
                <button style="display: none;" class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    Dropdown button
                </button>
                <div class="dropdown-menu" aria-labelledby="dropdownMenuButton" style="width: max-content;">
                    <div class="dropdown-menu-items">

                    </div>
                    <hr style="margin: 8px;">
                    <div style="padding: 0 8px">
                        <button class="btn btn-default">Добавить</button>
                    </div>
                </div>

            </div>
        </div>

        <div class="dropdown-item-template">
            <div style="padding: 4px 8px;" onclick="event.stopPropagation();//dropdown_item_click(this);event.stopPropagation();">
                <span class="dropdown-item">


                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" value="" id="defaultCheck1" style="margin: 0;;vertical-align: middle;cursor: pointer !important;">
                      <label class="form-check-label" for="defaultCheck1" onclick="dropdown_item_click(this);event.stopPropagation();" style="font-weight: normal;vertical-align: middle;padding-left: 4px;margin: 0;">
                            <span class="item-text">Action</span>
                      </label>
                    </div>

                </span>
            </div>
        </div>
    </div>




    <script type="text/javascript"><!--
        var editor = '{{ editor }}';
        {% for language in languages %}
        if(editor==='summernote'){
            $('#input-description{{ language['language_id'] }}').summernote({
                height: 300
            });
        }else{
            ckeditorInit('input-description{{ language['language_id'] }}', getURLVar('token'));
        }
        {% endfor %}
        //--></script>


    <script type="text/javascript"><!--
        $('#language a:first').tab('show');
        $('#cart-language a:first').tab('show');
        //--></script>


    <!--Вкладка Настройки-->
    <script type="text/javascript"><!--

        var product_row_index = 0;
        var link_product_row_index = {{ row_link_product }} ;
        var product_item_quantity_edit_default_value = {{ product_item_quantity_edit_default_value }} ;
        var image_placeholder = '{{ placeholder }}';

        function toggle_setting_form(element, parent) {
            var setting_form_id = $(element).attr('setting-form-id');

            $(parent).find('.' + setting_form_id).toggle();

            update_options_short_info();


        }

        $('#form-kit').submit(function () {
            update_items_empty_group_images();
            return true;
        });

        //15911
        var kit_price_mode_to_customer_group_row = {{kit_price_mode_to_customer_group_row}};

        function add_kit_price_mode_to_customer_group_row(element) {
            var html = "";

            html += '<div class="row kit-price-mode-to-customer-groups-row"style="margin-bottom:8px">';
            html += '<label class="col-sm-2"></label>';
            html += '<div class="col-sm-6">';
            html += ' <div  class="col-sm-4"  style="">';
            html += '   <select name="kit_price_mode_to_customer_groups['+kit_price_mode_to_customer_group_row+'][customer_group_id]" class="form-control">';
            {% for customer_group in customer_groups %}
            {% set customer_group_id = customer_group['customer_group_id'] %}
            {% set customer_group_name = customer_group['name'] %}
            html += '<option value="{{customer_group_id}}">{{customer_group_name}}</option>';
            {% endfor %}
            html += ' </select>';
            html += '</div>';
            html += '<div class="col-sm-4">';
            html += '<select name="kit_price_mode_to_customer_groups['+kit_price_mode_to_customer_group_row+'][kit_price_mode]" id="" class="form-control" onchange="">';
            {% for index, value in kit_price_mode_list %}
            html += '<option value="{{index}}">{{value}}</option>';
            {% endfor %}
            html += '</select>';
            html += '</div>';
            html += ' <div class="col-sm-2">';
            html += '<input type="text" name="kit_price_mode_to_customer_groups['+kit_price_mode_to_customer_group_row+'][value]" value="0" placeholder="" id="" class="form-control" />';
            html += '</div>';
            html += '<div class="col-sm-2"  style="">';
            html += '<a onclick="delete_kit_price_mode_to_customer_group_row(this);" title="" class="btn btn-default delete-button" style=""><i class="fa fa-minus-circle"></i></a>';
            html += '</div>';
            html += '';
            html += '</div>';
            html += '  <div class="col-sm-4"></div>';
            html += '</div>';
            html += '';




            $('.kit-price-mode-to-customer-groups-row-add-button').before(html);

            kit_price_mode_to_customer_group_row++;


        }

        function delete_kit_price_mode_to_customer_group_row(element) {
            $(element).closest('.kit-price-mode-to-customer-groups-row').replaceWith('');
        }



        function update_kit_price_mode_to_customer_groups_status() {
            var element = $("input[name=kit_price_mode_to_customer_groups_status]");
            if($(element).prop('checked')==true){
                $('#kit-price-mode-to-customer-groups').show();
            }else{
                $('#kit-price-mode-to-customer-groups').hide();
            }

        }

        function update_price_mode_to_customer_groups_status(element) {
            var item = $(element).closest('tr')
            if($(element).prop('checked')==true){
                $(item).find('.price-mode-to-customer-groups-container').show();
            }else{
                $(item).find('.price-mode-to-customer-groups-container').hide();
            }

        }
        function delete_price_mode_to_customer_group_row(element) {
            $(element).closest('.price-mode-to-customer-groups-row').replaceWith('');
        }
        function add_price_mode_to_customer_group_row(element) {
            var html = "";

            var rows_container = $(element).closest('.price-mode-to-customer-groups-container')

            var product_row_index = $(rows_container).closest('tr').attr('row-index');
            var row_index = $(rows_container).attr('rows-count');

            var group_row_clone = $('#price-mode-to-customer-groups-row-template .price-mode-to-customer-groups-row').clone();

            $(group_row_clone).removeClass('hidden');

            $(group_row_clone).find('#input-list-product-item-products-price-mode-to-customer-groups-customer-group-id').attr('be_input_name', 'list_product[' + product_row_index + '][price_mode_to_customer_groups]['+row_index+'][customer_group_id]');
            $(group_row_clone).find('#input-list-product-item-products-price-mode-to-customer-groups-price-mode').attr('be_input_name', 'list_product[' + product_row_index + '][price_mode_to_customer_groups]['+row_index+'][price_mode]');
            $(group_row_clone).find('#input-list-product-item-products-price-mode-to-customer-groups-value').attr('be_input_name', 'list_product[' + product_row_index + '][price_mode_to_customer_groups]['+row_index+'][value]');

            $(rows_container).find('.price-mode-to-customer-group-add-button').before(group_row_clone);

            row_index++;

            $(rows_container).attr('rows-count', row_index);
        }


        //15911

        //Обновление формы цены комплекта при смене значения

        function update_kit_price_mode() {
            element = $("select#input-kit-price-mode").first();

            element_value = $(element).find(':selected').val();

            $('[id^=kit-price-form-]').hide();

            if (element_value === 'sum') {
                $('[id^=kit-price-form-1]').show();
            }
            if (element_value === 'sum_minus_percent') {
                $('[id^=kit-price-form-2]').show();
            }
            if (element_value === 'sum_minus_value') {
                $('[id^=kit-price-form-3]').show();
            }
            if (element_value === 'sum_fix') {
                $('[id^=kit-price-form-4]').show();
            }

            if (element_value !== 'sum') {
                $('#form-kit-discount-by-product-count').show();
            } else {
                $('#form-kit-discount-by-product-count').hide();
            }


            update_kit_as_product_main_product_use_default_discount();
        }

        function update_specials_in_kit() {
            var value = $('select[name=enable_special]').val();
            if (value === "1") {
                $('.show-default-specials-in-kit-discounts-container').show();
            } else {
                $('.show-default-specials-in-kit-discounts-container').hide();
            }

        }

        function update_kit_as_product_main_product_use_default_discount() {
            element = $("select#input-kit-price-mode").first();

            element_value = $(element).find(':selected').val();

            if (element_value === 'sum_fix' && $('select[name=kit_as_product]').val() == 1) {
                $('#form-kit-as-product-main-product-use-default-discount').show();
            } else {
                $('#form-kit-as-product-main-product-use-default-discount').hide();
            }
        }

        function update_product_quantity_limit() {
            element = $("select#input-product-quantity-limit-status").first();

            element_value = $(element).find(':selected').val();

            $('[id^=product-quantity-limit-m]').hide();

            if (element_value === '1') {
                $('[id^=product-quantity-limit-m]').show();
            }

        }

        function update_kit_discount_by_product_count() {
            element = $("select#input-kit-discount-by-product-count-status").first();

            element_value = $(element).find(':selected').val();

            $('[id^=kit-discount-by-product-count-m]').hide();

            if (element_value === '1') {
                $('[id^=kit-discount-by-product-count-m]').show();
            }

        }

        //Обновление формы цены комплекта при смене значения
        function update_kit_quantity_mode() {
            element = $("select#input-kit-quantity-mode").first();

            element_value = $(element).find(':selected').val();

            $('[id^=kit-quantity-form]').hide();

            if (element_value === '1') {
                $('[id^=kit-quantity-form]').show();
            }

        }

        function update_kit_cart_limit_mode() {
            element = $("select#input-kit-cart-limit-mode").first();

            element_value = $(element).find(':selected').val();

            $('[id^=kit-cart-limit-form]').hide();

            if (element_value === '1') {
                $('[id^=kit-cart-limit-form]').show();
            }

        }

        function update_views_main_product_list() {

            var list_products = $('#kit-product-main-content .kit-product-list-item');

            for (i = 0; i < list_products.length; i++) {
                //Кнопка опций
                var has_options = $(list_products[i]).find('#input-list-product-has-options').val();
                if (has_options === 'true' || has_options === '1') {
                    $(list_products[i]).find('.options-button').css('display', 'inline-block');
                    ;
                } else {
                    $(list_products[i]).find('.options-button').hide();

                }

                $(list_products[i]).find('#input-list-product-name-filter').attr('disabled', 'disabled');

            }

            $('#kit-product-main-content .delete-button').closest('td').hide();


            var element = $('select[name=kit_as_product]').first();
            var value = parseInt($(element).val());
            if (value == 1) {
                $('#input-kit-mode').val('list_product');
                // $('#input-kit-mode').addClass('disabled-select-input');
                $('#input-kit-mode').prop('disabled', 'disabled');
                $('#form-group-main-product').hide();
            } else {
                // $('#input-kit-mode').removeClass('disabled-select-input');
                $('#input-kit-mode').prop('disabled', '');
                $('#form-group-main-product').show();

            }

        }

        function update_views_product_list() {

            //Если нет "Привязанных товаров", то включаем режим 'list_product'
            //Для шаблонов импорта это делать не надо
            //15913
            //Если нет "Привязанных товаров", то отключаем режим режим 'main_product'
            if ($('#import-template-main-container').length === 0) {
                var link_products_count = $('#link-product [id^=link-product]').length;
                if (link_products_count === 0) {
                    // $('select[name=kit_mode]').val('list_product');
                    //15913
                    if($('select[name=kit_mode]').val()=='main_product'){
                        $('select[name=kit_mode]').val('list_product');
                    }
                    //15913
                }
            }




            //Если тип комплекта "Список", то скрывает раздел основного товара
            //и меняем названия
            //15913
            if ($('#input-kit-mode :selected').val() === 'list_product' || $('#input-kit-mode :selected').val() === 'auto_list') {
                //15913
                // if ($('#input-kit-mode :selected').val() === 'list_product') {
                $('#form-group-main-product').hide();
                $('#form-group-main-product #kit-product-main-content').html('');
            } else {
                $('#form-group-main-product').show();
            }

            //15913
            //Показываем настройку автоматического разбиения на группы, если автоматический режим подбора товара
            if ($('#input-kit-mode :selected').val() === 'auto_list') {
                $('#form-group-auto-list-grouping').show();
            } else {
                $('#form-group-auto-list-grouping').hide();
            }
            //15913

            //15913
            update_list_product_select_mode();
            //15913

            //Для всех товаров
            //Если цена товара, то скрываем поле назначения цены
            //Если "Фиксированный Товар", то оставляем только первый продукт
            //Если "Товар на выбор", внизу позиции кнопка Добавить товар и оставить Выпадающий список только для первого товара

            //Сначала удаляем все кнопки "добавить" для товаров на выбор и для главных продуктов
            $('#kit-product-list .select-product-add-button').closest('tr').remove();
            // $('#kit-product-main-content .delete-button').remove();

            //Если фиксированный товар, а в товаре категория, то либо ищем товар и вставляем его на первое место, либо очичаем поле товара

            //Скрываем\показываем при необходимости цену
            $('.kit-product-list-item').each(function (index, element) {
                $(element).find('#input-list-product-price, #input-list-product-price-minus-sum, #input-list-product-price-minus-percent').hide();
                if ($(element).find('#input-list-product-price-mode :selected').val() === 'fix_price') {
                    $(element).find('#input-list-product-price').show();
                }
                if ($(element).find('#input-list-product-price-mode :selected').val() === 'product_price_minus_sum') {
                    $(element).find('#input-list-product-price-minus-sum').show();
                }
                if ($(element).find('#input-list-product-price-mode :selected').val() === 'product_price_minus_percent') {
                    $(element).find('#input-list-product-price-minus-percent').show();
                }
            })

            var list_products = $('#kit-product-list-content .kit-product-list-item');
            var prev_item_mode = '';
            var prev_item_position = 0;
            for (i = 0; i < list_products.length; i++) {
                var item_mode = $(list_products[i]).find('#input-list-product-item-mode :selected').val();
                var item_position = $(list_products[i]).find('#input-list-product-item-position').val();
                var remove_item_product = $(list_products[i]).find('#input-list-product-remove-item-product').val();
                if (i >= (list_products.length - 1))
                    var next_position = '-1';
                else
                    var next_position = $(list_products[i + 1]).find('#input-list-product-item-position').val();

                //Для товара на выбор скрываем выбор режима для всех кроме первого элемента
                $(list_products[i]).find('#input-list-product-item-mode').show();
                if ((item_mode === 'select_product' || item_mode === 'free_product') && item_position === prev_item_position) {
                    $(list_products[i]).find('#input-list-product-item-mode').hide();
                } else {

                }

                //В конце списка на выбор выводим кнопку добавить
                if ((item_mode === 'select_product' || item_mode === 'free_product') && item_position !== next_position) {
                    var clone = $('#select-product-add-button-template').first().clone();

                    $(clone).attr('id', '');
                    $(clone).attr('item-mode', item_mode);
                    $(clone).find('a.select-product-add-button').attr('item-position', item_position);

                    $(list_products[i]).after(clone);

                    $(clone).show();
                }

                //Кнопка опций
                var has_options = $(list_products[i]).find('#input-list-product-has-options').val();
                if (has_options === 'true' || has_options === '1') {
                    $(list_products[i]).find('.options-button').css('display', 'inline-block');
                    ;
                } else {
                    $(list_products[i]).find('.options-button').hide();

                }

                prev_item_mode = item_mode;
                prev_item_position = item_position;
            }


        }

        //Ставим номера
        function update_views_column_position() {
            var prev_item_position = '';
            var display_item_position = 1;

            if ($('#input-kit-mode').val() === 'main_product') {
                $('#kit-product-main-content .kit-product-list-item .column-position .item-position-container').html('');
                var element = $('#kit-product-main-content .kit-product-list-item').first();
                var item_position = $(element).attr('item-position');

                if (item_position !== prev_item_position) {
                    $(element).find('.column-position .item-position-container').html((display_item_position));
                }

                display_item_position++;
            }


            $('#kit-product-list #kit-product-list-content .kit-product-list-item .column-position .item-position-container').html('');
            $('#kit-product-list #kit-product-list-content .kit-product-list-item').each(function (index, element) {

                //15913
                //При смене free_position на fixed часть элементов скрывается чтобы потом удалить, поэтому их считать не надо
                if($(element).find('input#input-list-product-remove-item-product').val()=="1"){
                    return;
                }
                //15913

                var item_position = $(element).attr('item-position');

                if (item_position !== prev_item_position) {
                    $(element).find('.column-position .item-position-container').html((display_item_position));
                    display_item_position++;
                }

                prev_item_position = item_position;
            })
        }

        //Обновляем индексы
        function on_item_mode_changed(element) {

            var item_mode = $(element).find(':selected').val();
            var item_position = $(element).closest('.kit-product-list-item').attr('item-position');

            var item_products = $('#kit-product-list .kit-product-list-item[item-position=' + item_position + ']');

            if (item_mode === 'fix_product') {
                //Все элементы делаем remove_item_product, кроме первого товара, делаем fix_product и скрываем их. Или добавляем его

                // var first_product_item = $(item_products).find('input[id=input-list-product-item-type][value=product], input[id=input-list-product-item-type][value=""]').first();
                var first_product_item = $(item_products).find('input[id=input-list-product-item-type][value=product]').first();

                $(item_products).find('#input-list-product-remove-item-product').val(1);
                $(item_products).find('#input-list-product-item-mode').val('fix_product');
                $(item_products).hide();

                if ($(first_product_item).length !== 0) {
                    first_product_item = $(first_product_item).closest('tr.kit-product-list-item').first();
                    $(first_product_item).find('#input-list-product-remove-item-product').val(0);
                    // $(first_product_item).addClass('111222');
                    $(first_product_item).show();
                } else {
                    // var element_add_button =$();
                    // item_position = item_position
                    add_new_product(item_position);

                    var item_products = $('.kit-product-list-item[item-position=' + item_position + ']');
                    $(item_products).find('#input-list-product-item-mode').val('fix_product');

                }


            } else {
                //Все элементы делаем не remove_item_product, кроме первого товара, делаем select_product и скрываем их.
                $(item_products).find('#input-list-product-remove-item-product').val(0);
                $(item_products).find('#input-list-product-item-mode').val(item_mode);
                $(item_products).show();
            }


            update_views();
        }

        function update_options_short_info() {


            $('.setting-form-options').each(function (index, element) {

                var has_disable_options = false;
                var has_fixed_options = false;
                var has_enabled_options = false;

                var disabled_options_string = '';
                var disabled_options = $(element).find('#disable-options').children();

                var enabled_options_string = '';
                var enabled_options = $(element).find('#enabled-options').children();

                var fixed_options_string = '';
                var fixed_options = $(element).find('#fixed-options').children();

                for (var i = 0; i < disabled_options.length; i++) {
                    var option = disabled_options[i];
                    disabled_options_string += $(option).find('#input-option-name').val() + "; ";
                    has_disable_options = true;
                }
                for (var i = 0; i < enabled_options.length; i++) {
                    var option = enabled_options[i];
                    enabled_options_string += $(option).find('#input-option-name').val() + "; ";
                    has_enabled_options = true;
                }
                for (var i = 0; i < fixed_options.length; i++) {
                    var option = fixed_options[i];
                    fixed_options_string += $(option).find('#input-option-name').val() + "; ";
                    has_fixed_options = true;
                }

                $(element).closest('.kit-product-list-item').find('.setting-form-options-info .options-info-disabled-string').html(disabled_options_string);
                $(element).closest('.kit-product-list-item').find('.setting-form-options-info .options-info-enabled-string').html(enabled_options_string);
                $(element).closest('.kit-product-list-item').find('.setting-form-options-info .options-info-fixed-string').html(fixed_options_string);

                if (disabled_options.length > 0) {
                    $(element).closest('.kit-product-list-item').find('.setting-form-options-info .options-info-disabled').show();
                } else {
                    $(element).closest('.kit-product-list-item').find('.setting-form-options-info .options-info-disabled').hide();
                }

                if (enabled_options.length > 0) {
                    $(element).closest('.kit-product-list-item').find('.setting-form-options-info .options-info-enabled').show();
                } else {
                    $(element).closest('.kit-product-list-item').find('.setting-form-options-info .options-info-enabled').hide();
                }

                if (fixed_options.length > 0) {
                    $(element).closest('.kit-product-list-item').find('.setting-form-options-info .options-info-fixed').show();
                } else {
                    $(element).closest('.kit-product-list-item').find('.setting-form-options-info .options-info-fixed').hide();
                }

                var display = $(element).closest('.kit-product-list-item').find('.setting-form-options').css('display');

                if ((has_disable_options || has_fixed_options || has_enabled_options) && display === 'none') {
                    $(element).closest('.kit-product-list-item').find('.setting-form-options-info').show();
                } else {
                    $(element).closest('.kit-product-list-item').find('.setting-form-options-info').hide();
                }

            })


        }

        //Сделал в отдельном обработчике, т.к. при смене картинки невозможно его вызвать и вызывается при разных манипуляциях
        function update_items_empty_group_images() {

            var list_products = $('#kit-product-list .kit-product-list-item');

            //Из первого Копируем значения для всех скрытых
            var prev_item_mode = '';
            var prev_item_position = 0;
            var first_item_element = '';
            for (var i = 0; i < list_products.length; i++) {

                var item_position = $(list_products[i]).find('#input-list-product-item-position').val();
                var item_mode = $(list_products[i]).find('#input-list-product-item-mode').val();

                if (item_position !== prev_item_position) {
                    first_item_element = list_products[i];
                }

                if (item_position === prev_item_position) {

                    $(list_products[i]).find('[id^=input-list-product-empty-group-image]').val($(first_item_element).find('[id^=input-list-product-empty-group-image]').val());
                    $(list_products[i]).find('[id^=empty-group-image-thumb-] img').attr('src', $(first_item_element).find('[id^=empty-group-image-thumb-] img').attr('src'));

                }

                prev_item_mode = item_mode;
                prev_item_position = item_position;
            }


        }

        function update_items_empty_mode_info() {

            var list_products = $('#kit-product-list .kit-product-list-item');
            var prev_item_mode = '';
            var prev_item_position = 0;

            for (var i = 0; i < list_products.length; i++) {
                var item_position = $(list_products[i]).find('#input-list-product-item-position').val();
                var item_mode = $(list_products[i]).find('#input-list-product-item-mode').val();


                $(list_products[i]).find('.select-product-empty-mode-form').show();
                $(list_products[i]).find('#item-empty-mode-setting-button, .select-product-empty-mode-form label').show();
                // $(list_products[i]).find('.select-product-empty-mode-form-container').hide();

                //Для товара на выбор скрываем выбор режима для всех кроме первого элемента
                if (item_mode === 'fix_product') {
                    $(list_products[i]).find('.select-product-empty-mode-form').hide();
                } else {
                    if ($(list_products[i]).find('#input-list-product-item-empty-mode-enable').prop('checked')) {
                        $(list_products[i]).find('#item-empty-mode-setting-button').show();
                        //$(list_products[i]).find('.select-product-empty-mode-form-container').show();
                    } else {
                        $(list_products[i]).find('#item-empty-mode-setting-button').hide();
                        //$(list_products[i]).find('.select-product-empty-mode-form-container').hide();

                    }
                    // $(list_products[i]).find('.select-product-empty-mode-form-container').hide();


                    if (item_position === prev_item_position) {
                        $(list_products[i]).find('.select-product-empty-mode-form').hide();
                    }
                }

                //Если "свободный товар", то названия делаем видимыми всегда, а кнопки скрываем
                if (item_mode === 'free_product') {
                    $(list_products[i]).find('#item-empty-mode-setting-button, .select-product-empty-mode-form label').hide();
                    $(list_products[i]).find('.select-product-empty-mode-form-container').show();

                }

                if (item_mode === 'fix_product') {
                    $(list_products[i]).find('.select-product-hide-special-products-form').hide();
                    $(list_products[i]).find('.select-product-products-combine-mode-form').hide();
                    $(list_products[i]).find('.select-product-products-randomize-select-product-form').hide();
                    $(list_products[i]).find('.select-product-empty-group-image-form').hide();
                } else {
                    $(list_products[i]).find('.select-product-hide-special-products-form').show();
                    $(list_products[i]).find('.select-product-products-combine-mode-form').show();
                    $(list_products[i]).find('.select-product-empty-group-image-form').show();
                    if (item_mode === 'select_product') {
                        $(list_products[i]).find('.select-product-products-randomize-select-product-form').show();
                    } else {
                        $(list_products[i]).find('.select-product-products-randomize-select-product-form').hide();
                    }
                    if (item_position === prev_item_position) {
                        $(list_products[i]).find('.select-product-hide-special-products-form').hide();
                        $(list_products[i]).find('.select-product-products-combine-mode-form').hide();
                        $(list_products[i]).find('.select-product-products-randomize-select-product-form').hide();
                        $(list_products[i]).find('.select-product-empty-group-image-form').hide();
                    }
                }


                prev_item_mode = item_mode;
                prev_item_position = item_position;
            }

            //Из первого Копируем значения для всех скрытых
            var prev_item_mode = '';
            var prev_item_position = 0;
            var first_item_element = '';
            for (var i = 0; i < list_products.length; i++) {

                var item_position = $(list_products[i]).find('#input-list-product-item-position').val();
                var item_mode = $(list_products[i]).find('#input-list-product-item-mode').val();

                if (item_position !== prev_item_position) {
                    first_item_element = list_products[i];
                }

                if (item_position === prev_item_position) {
                    $(list_products[i]).find('#input-list-product-item-empty-mode-enable').val($(first_item_element).find('#input-list-product-item-empty-mode-enable').val());
                    $(list_products[i]).find('#input-list-product-item-empty-mode-enable').prop('checked', $(first_item_element).find('#input-list-product-item-empty-mode-enable').prop('checked'));

                    $(list_products[i]).find('#input-list-product-item-empty-mode-default-empty').val($(first_item_element).find('#input-list-product-item-empty-mode-default-empty').val());
                    $(list_products[i]).find('#input-list-product-item-empty-mode-default-empty').prop('checked', $(first_item_element).find('#input-list-product-item-empty-mode-default-empty').prop('checked'));

                    $(list_products[i]).find('#input-list-product-item-hide-special-products').val($(first_item_element).find('#input-list-product-item-hide-special-products').val());
                    $(list_products[i]).find('#input-list-product-item-hide-special-products').prop('checked', $(first_item_element).find('#input-list-product-item-hide-special-products').prop('checked'));

                    var new_value = $(first_item_element).find('#input-list-product-item-products-combine-mode').val();
                    $(list_products[i]).find('#input-list-product-item-products-combine-mode').val(new_value);
                    // $(list_products[i]).find('#input-list-product-item-products-combine-mode').prop('checked', $(first_item_element).find('#input-list-product-item-products-combine-mode').prop('checked'));

                    $(list_products[i]).find('#input-list-product-item-products-randomize-select-product').val($(first_item_element).find('#input-list-product-item-products-randomize-select-product').val());
                    $(list_products[i]).find('#input-list-product-item-products-randomize-select-product').prop('checked', $(first_item_element).find('#input-list-product-item-products-randomize-select-product').prop('checked'));

                    $(list_products[i]).find('[id^=input-list-product-empty-group-image]').val($(first_item_element).find('[id^=input-list-product-empty-group-image]').val());
                    $(list_products[i]).find('[id^=empty-group-image-thumb-] img').attr('src', $(first_item_element).find('[id^=empty-group-image-thumb-] img').attr('src'));


                    $(list_products[i]).find('[id^=input-list-product-item-empty-mode-title]').each(function (index, element) {
                        var lng_id = $(element).attr('language-id');
                        $(element).val($(first_item_element).find('#input-list-product-item-empty-mode-title' + lng_id).val());
                    })
                }

                prev_item_mode = item_mode;
                prev_item_position = item_position;
            }


        }

        //free_product_default_in_kit показываем только для free_products
        function update_free_product_default_in_kit_container() {
            $('.kit-product-list-item .container-free-product-default-in-kit').hide();

            $('#kit-product-list .kit-product-list-item').each(function (index, element) {
                var item_mode = $(element).find('#input-list-product-item-mode').val();
                if (item_mode === 'free_product') {
                    $(element).find('.container-free-product-default-in-kit').show();
                }
            })

        }

        function update_views() {
            update_views_main_product_list();

            update_views_product_list();

            update_views_column_position();

            update_kit_price_mode();

            //15911
            update_kit_price_mode_to_customer_groups_status();
            //15911

            update_specials_in_kit();

            update_product_quantity_limit();

            update_kit_discount_by_product_count();

            update_kit_quantity_mode();

            update_kit_cart_limit_mode();

            update_free_product_default_in_kit_container();

            update_options_short_info();

            update_items_empty_mode_info();

            update_items_empty_group_images();

            update_items_positions_arrows();

            update_price_rewrite();

            update_link_product_combine_mode_buttons();

            update_product_combine_mode_buttons();
        }

        function update_price_rewrite() {
            var val = $('select[name=save_kit_as_product_total]').val();
            if (val == 1) {
                $('#text-warning-price-rewrite').show();

            } else {
                $('#text-warning-price-rewrite').hide();

            }
        }

        function on_click_link_product_combine_mode(element) {
            var value = $(element).attr('data-key-value');

            var form = $(element).closest('#form-group-link-product-combine-mode');

            var input = $(form).find('#input-link-products-combine-mode');

            $(input).val(value);

            //update_items_empty_mode_info();

            update_link_product_combine_mode_buttons();
        }

        function update_link_product_combine_mode_buttons() {
            var form = $('#form-group-link-product-combine-mode')
            var input = $(form).find('#input-link-products-combine-mode');
            var value = $(input).val();

            var show = true;
            if ($('#link-product').find('[id^=link-product]').length > 1) {
                show = true;
            } else {
                show = false;
            }
            if (show) {
                $(form).show();
            } else {
                $(form).hide();
            }

            //Меняем цвет активной кнопки


            var buttons = $(form).find('button');
            $(buttons).removeClass('active-combine-mode-button');
            var active_button = $(form).find('button[data-key-value=' + value + ']');
            $(active_button).addClass('active-combine-mode-button');
        }

        //Для товаров на выбор и свободных товаров показываем\скрываем кнопки способов объединения товаров
        function on_click_product_combine_mode(element) {
            var value = $(element).attr('data-key-value');

            var form = $(element).closest('.select-product-products-combine-mode-form');

            var input = $(form).find('#input-list-product-item-products-combine-mode');

            $(input).val(value);

            update_items_empty_mode_info();

            update_product_combine_mode_buttons();
        }



        function update_product_combine_mode_buttons() {
            //Для списка товаров
            $('#kit-product-list').find('tr.kit-product-list-item').each(function (index, row) {
                // var row = $(element).closest('tr');
                var item_position = parseInt($(row).attr('item-position'));
                var items_rows = $('#kit-product-list').find('tr.kit-product-list-item[item-position=' + item_position + ']');

                var show = true;
                if ($(items_rows).first().is(row)) {
                    if ($(items_rows).length > 1) {
                        show = true;
                    } else {
                        show = false;
                    }
                } else {
                    show = false;
                }

                //В режиме импорта показывать всегда
                if($('#import-template-main-container').length>0){
                    show = true;
                    if($(row).find('#input-list-product-item-mode').val()==="fix_product"){
                        show = false;
                    }
                }

                if (show) {
                    $(row).find('.select-product-products-combine-mode-form').show();
                } else {
                    $(row).find('.select-product-products-combine-mode-form').hide();
                }

                //Меняем цвет активной кнопки
                var form = $(row).find('.select-product-products-combine-mode-form')
                var value = $(form).find('#input-list-product-item-products-combine-mode').val();
                var buttons = $(form).find('button');
                $(buttons).removeClass('active-combine-mode-button');
                var active_button = $(form).find('button[data-key-value=' + value + ']');
                $(active_button).addClass('active-combine-mode-button');
            });
        }

        //Обновляем стрелки для перемещений. Для Топовых элементов стрелки двойные
        function update_items_positions_arrows() {
            $('#kit-product-list').find('tr.kit-product-list-item').each(function (index, row) {
                // var row = $(element).closest('tr');
                var item_position = parseInt($(row).attr('item-position'));
                var items_rows = $('#kit-product-list').find('tr.kit-product-list-item[item-position=' + item_position + ']');

                //Если первый элемент среди группы, то перемещаем по позициям, причем сразу все элементы позиции
                //Иначе перемещаем внутри группы
                if ($(items_rows).first().is(row)) {

                    $(row).find('.item-position-arrows.top-item').show();
                    $(row).find('.item-position-arrows.child-item').hide();

                } else {
                    $(row).find('.item-position-arrows.top-item').hide();
                    $(row).find('.item-position-arrows.child-item').show();
                }
            });

        }

        function update_items_positions() {

            if ($('select#input-kit-mode  option:selected').val() == "main_product") {
                var position = 0;
            } else {
                var position = -1;
            }
            //var position = -1;
            var prev_item_position = -1;
            $('#kit-product-list').find('tr.kit-product-list-item').each(function (endex, element) {

                var current_item_position = $(element).attr('item-position');
                if (current_item_position !== prev_item_position) {
                    position++;
                }

                $(element).attr('item-position', position);
                $(element).find('#input-list-product-item-position').val(position);

                prev_item_position = current_item_position;

            })
        }

        function update_main_products() {

            $('#kit-product-main-content').html('');
            $('#link-product').find('[id^=link-product]').each(function (index, value) {
                var item_id = $(value).find('input[name$="[item_id]"]').val();
                var item_value = $(value).find('input[name$="[item_value]"]').val();
                var item_type = $(value).find('input[name$="[item_type]"]').val();
                var name = $(value).find('input[name$="[name]"]').val();

                // var item_id='item_id';
                var item_mode = 'fix_product';
                // var item_type='';
                //1575
                var item_position = 0;
                // var item_position=product_row_index+1;

                var quantity = '1';
                var price_mode = 'product_price';
                var custom_field = '';
                var price = '0';
                var price_minus_sum = '0';
                var price_minus_percent = '0'
                // var name='';
                var main = '1';
                var has_options = $(value).find('input[name$="[has_options]"]').val();
                var disable_options = [];//TODO
                var enabled_options = [];//TODO
                var fixed_options = [];//TODO
                var store_status = 1;
                // var disable_options_info_string = "";
                // var fixed_options_info_string = "";
                var item_empty_mode_enable = '';
                var item_empty_mode_default_empty = '';
                var item_empty_mode_not_empty_in_cart = 0;
                var item_empty_mode_title = [];
                var quantity_edit = false;
                var free_product_default_in_kit = false;

                var hide_special_products = false;
                var products_combine_mode = 'union';
                var empty_group_image = '';
                var empty_group_image_thumb = image_placeholder;

                var randomize_select_product = 0;

                //15911
                var price_mode_to_customer_groups_status = false;
                var price_mode_to_customer_groups = [];
                //15911

                add_product(item_id, item_value, item_mode, quantity, price_mode, price, price_minus_sum, price_minus_percent, name, main, item_position, item_type, has_options, disable_options, enabled_options, fixed_options, store_status, item_empty_mode_enable, item_empty_mode_default_empty, item_empty_mode_not_empty_in_cart, item_empty_mode_title, quantity_edit, free_product_default_in_kit, hide_special_products, products_combine_mode, empty_group_image, empty_group_image_thumb, randomize_select_product, custom_field, price_mode_to_customer_groups_status, price_mode_to_customer_groups);

            });

            update_items_positions();
            update_views();
        }

        function on_change_item_empty_mode(element) {
            update_items_empty_mode_info();

            if ($(element).prop('checked')) {
                $(element).closest('.select-product-empty-mode-form').find('.select-product-empty-mode-form-container').show();
            } else {
                $(element).closest('.select-product-empty-mode-form').find('.select-product-empty-mode-form-container').hide();
            }
        }

        function add_new_main_product() {
            var item_id = '';
            var item_value = '';
            var item_mode = 'select_product';
            var item_type = '';
            var item_position = product_row_index + 1;
            var quantity = '1';
            var price_mode = 'product_price';
            var custom_field = '';
            var price = '0';
            var price_minus_sum = '0';
            var price_minus_percent = '0'
            var name = '';
            var main = '1';
            var has_options = false;
            var disable_options = [];
            var enabled_options = [];
            var fixed_options = [];
            var store_status = 1;

            var item_empty_mode_enable = '';
            var item_empty_mode_default_empty = '';
            var item_empty_mode_not_empty_in_cart = 0;
            var item_empty_mode_title = [];
            var quantity_edit = false;
            var free_product_default_in_kit = false;

            var hide_special_products = false;
            var products_combine_mode = 'union';
            var empty_group_image = '';
            var empty_group_image_thumb = image_placeholder;

            var randomize_select_product = 0;

            //15911
            var price_mode_to_customer_groups_status = false;
            var price_mode_to_customer_groups = [];
            //15911

            // var disable_options_info_string = "";
            // var fixed_options_info_string = "";

            add_product(item_id, item_value, item_mode, quantity, price_mode, price, price_minus_sum, price_minus_percent, name, main, item_position, item_type, has_options, disable_options, enabled_options, fixed_options, store_status, item_empty_mode_enable, item_empty_mode_default_empty, item_empty_mode_not_empty_in_cart, item_empty_mode_title, quantity_edit, free_product_default_in_kit, hide_special_products, products_combine_mode, empty_group_image, empty_group_image_thumb, randomize_select_product, custom_field, price_mode_to_customer_groups_status, price_mode_to_customer_groups);

            update_views();
        }

        function get_last_item_position() {
            var last_item_position = -1;

            var last_item = $('#kit-product-list .kit-product-list-item').last();

            if ($(last_item).length > 0) {
                last_item_position = parseInt($(last_item).attr('item-position'));
            } else {
                if ($('#input-kit-mode :selected').val() === 'main_product') {
                    last_item_position = 0;
                }
            }

            return last_item_position;

        }

        function add_new_product() {
            var item_id = '';
            var item_value = '';
            var item_mode = 'fix_product';
            var item_type = '';
            //var item_position=product_row_index+1;
            var item_position = get_last_item_position() + 1;
            var quantity = '1';
            var price_mode = 'product_price';
            var custom_field = '';
            var price = '0';
            var price_minus_sum = '0';
            var price_minus_percent = '0'
            var name = '';
            var main = '0';
            var has_options = false;
            var disable_options = [];
            var enabled_options = [];
            var fixed_options = [];
            var store_status = 1;

            // var disable_options_info_string = "";
            // var fixed_options_info_string = "";
            var item_empty_mode_enable = '';
            var item_empty_mode_default_empty = '';
            var item_empty_mode_not_empty_in_cart = 0;
            var item_empty_mode_title = [];
            var quantity_edit = product_item_quantity_edit_default_value;
            var free_product_default_in_kit = 0;

            var hide_special_products = false;
            var products_combine_mode = 'union';
            var empty_group_image = '';
            var empty_group_image_thumb = image_placeholder;

            var randomize_select_product = 0;

            //15911
            var price_mode_to_customer_groups_status = false;
            var price_mode_to_customer_groups = [];
            //15911

            add_product(item_id, item_value, item_mode, quantity, price_mode, price, price_minus_sum, price_minus_percent, name, main, item_position, item_type, has_options, disable_options, enabled_options, fixed_options, store_status, item_empty_mode_enable, item_empty_mode_default_empty, item_empty_mode_not_empty_in_cart, item_empty_mode_title, quantity_edit, free_product_default_in_kit, hide_special_products, products_combine_mode, empty_group_image, empty_group_image_thumb, randomize_select_product, custom_field, price_mode_to_customer_groups_status, price_mode_to_customer_groups);

            update_views();
        }

        function add_new_product_select(item_position, item_mode) {

            var item_id = '';
            var item_value = '';
            // var item_mode='select_product';
            var item_mode = item_mode;
            var item_type = '';
            // var item_position=$(element).closest('.kit-product-list-item').find('#input-list-product-item-position').val();
            // var item_position=$(element).closest('tr').prev().find('#input-list-product-item-position').val();
            var item_position = item_position;
            var quantity = '1';
            var price_mode = 'product_price';
            var custom_field = '';
            var price = '0';
            var price_minus_sum = '0';
            var price_minus_percent = '0';
            var name = '';
            var main = '0';
            var has_options = false;
            var disable_options = [];
            var enabled_options = [];
            var fixed_options = [];
            var store_status = 1;

            var item_empty_mode_enable = '';
            var item_empty_mode_default_empty = '';
            var item_empty_mode_not_empty_in_cart = 0;
            var item_empty_mode_title = [];
            var quantity_edit = product_item_quantity_edit_default_value;
            var free_product_default_in_kit = 0;

            var hide_special_products = false;
            var products_combine_mode = 'union';
            var empty_group_image = '';
            var empty_group_image_thumb = image_placeholder;

            var randomize_select_product = 0;

            // var disable_options_info_string = "";
            // var fixed_options_info_string = "";

            //15911
            var price_mode_to_customer_groups_status = false;
            var price_mode_to_customer_groups = [];
            //15911

            add_product(item_id, item_value, item_mode, quantity, price_mode, price, price_minus_sum, price_minus_percent, name, main, item_position, item_type, has_options, disable_options, enabled_options, fixed_options, store_status, item_empty_mode_enable, item_empty_mode_default_empty, item_empty_mode_not_empty_in_cart, item_empty_mode_title, quantity_edit, free_product_default_in_kit, hide_special_products, products_combine_mode, empty_group_image, empty_group_image_thumb, randomize_select_product, custom_field, price_mode_to_customer_groups_status, price_mode_to_customer_groups);

            update_views();
        }

        function add_product(item_id, item_value, item_mode, quantity, price_mode, price, price_minus_sum, price_minus_percent, name, main, item_position, item_type, has_options, disable_options, enabled_options, fixed_options, store_status, item_empty_mode_enable, item_empty_mode_default_empty, item_empty_mode_not_empty_in_cart, item_empty_mode_title, quantity_edit, free_product_default_in_kit, hide_special_products, products_combine_mode, empty_group_image, empty_group_image_thumb, randomize_select_product, custom_field, price_mode_to_customer_groups_status, price_mode_to_customer_groups) {

            var clone = $('#kit-product-list-template').first().clone();

            product_row_index++;

            $(clone).attr('row-index', product_row_index);
            $(clone).attr('item-position', item_position);
            $(clone).attr('item-id', item_id);
            $(clone).attr('item-value', item_value);
            $(clone).attr('id', '');
            $(clone).addClass('kit-product-list-item');

            $(clone).find('#input-list-product-item-mode').val(item_mode);
            if (item_empty_mode_enable) {
                $(clone).find('#input-list-product-item-empty-mode-enable').val(1);
                $(clone).find('#input-list-product-item-empty-mode-enable').prop('checked', true);
            } else {
                $(clone).find('#input-list-product-item-empty-mode-enable').val(0);
                $(clone).find('#input-list-product-item-empty-mode-enable').prop('checked', false);
            }
            if (item_empty_mode_default_empty) {
                $(clone).find('#input-list-product-item-empty-mode-default-empty').val(1);
                $(clone).find('#input-list-product-item-empty-mode-default-empty').prop('checked', true);
            } else {
                $(clone).find('#input-list-product-item-empty-mode-default-empty').val(0);
                $(clone).find('#input-list-product-item-empty-mode-default-empty').prop('checked', false);
            }
            if (item_empty_mode_not_empty_in_cart) {
                $(clone).find('#input-list-product-item-empty-mode-not-empty-in-cart').val(1);
                $(clone).find('#input-list-product-item-empty-mode-not-empty-in-cart').prop('checked', true);
            } else {
                $(clone).find('#input-list-product-item-empty-mode-not-empty-in-cart').val(0);
                $(clone).find('#input-list-product-item-empty-mode-not-empty-in-cart').prop('checked', false);
            }
            for (var language_id in item_empty_mode_title) {
                $(clone).find('#input-list-product-item-empty-mode-title' + language_id).val(item_empty_mode_title[language_id])
            }

            if (hide_special_products) {
                $(clone).find('#input-list-product-item-hide-special-products').val(1);
                $(clone).find('#input-list-product-item-hide-special-products').prop('checked', true);
            } else {
                $(clone).find('#input-list-product-item-hide-special-products').val(0);
                $(clone).find('#input-list-product-item-hide-special-products').prop('checked', false);
            }

            // if(products_combine_mode==='intersect'){
            //     $(clone).find('#input-list-product-item-products-combine-mode').val(1);
            //     $(clone).find('#input-list-product-item-products-combine-mode').prop('checked', true);
            // }else{
            //     $(clone).find('#input-list-product-item-products-combine-mode').val(0);
            //     $(clone).find('#input-list-product-item-products-combine-mode').prop('checked', false);
            // }
            $(clone).find('#input-list-product-item-products-combine-mode').val(products_combine_mode);

            if (randomize_select_product) {
                $(clone).find('#input-list-product-item-products-randomize-select-product').val(1);
                $(clone).find('#input-list-product-item-products-randomize-select-product').prop('checked', true);
            } else {
                $(clone).find('#input-list-product-item-products-randomize-select-product').val(0);
                $(clone).find('#input-list-product-item-products-randomize-select-product').prop('checked', false);
            }


            $(clone).find('#empty-group-image-thumb img').attr('src', empty_group_image_thumb);
            $(clone).find('#input-list-product-empty-group-image').val(empty_group_image);


            $(clone).find('#input-list-product-item-type').val(item_type);
            $(clone).find('#input-list-product-item-id').val(item_id);
            $(clone).find('#input-list-product-item-value').val(item_value);
            $(clone).find('#input-list-product-item-position').val(item_position);
            $(clone).find('#input-list-product-quantity').val(quantity);
            if (quantity_edit) {
                $(clone).find('#input-list-product-item-quantity-edit').val(1);
                $(clone).find('#input-list-product-item-quantity-edit').prop('checked', true);
            } else {
                $(clone).find('#input-list-product-item-quantity-edit').val(0);
                $(clone).find('#input-list-product-item-quantity-edit').prop('checked', false);
            }
            if (free_product_default_in_kit) {
                $(clone).find('#input-list-product-item-free-product-default-in-kit').val(1);
                $(clone).find('#input-list-product-item-free-product-default-in-kit').prop('checked', true);
            } else {
                $(clone).find('#input-list-product-item-free-product-default-in-kit').val(0);
                $(clone).find('#input-list-product-item-free-product-default-in-kit').prop('checked', false);
            }
            $(clone).find('#input-list-product-price-mode').val(price_mode);
            $(clone).find('#input-list-product-custom-field').val(custom_field);
            $(clone).find('#input-list-product-price').val(price);
            $(clone).find('#input-list-product-price-minus-sum').val(price_minus_sum);
            $(clone).find('#input-list-product-price-minus-percent').val(price_minus_percent);
            $(clone).find('#input-list-product-name-filter').val(name);
            $(clone).find('#input-list-product-name').val(name);
            $(clone).find('#input-list-product-main').val(main);
            $(clone).find('#input-list-product-has-options').val(has_options);


            $(clone).find('#input-list-product-name-filter').attr('be_input_name', 'list_product[' + product_row_index + '][filter_name]');

            $(clone).find('#input-list-product-item-mode').attr('be_input_name', 'list_product[' + product_row_index + '][item_mode]');
            $(clone).find('#input-list-product-item-empty-mode-enable').attr('be_input_name', 'list_product[' + product_row_index + '][item_empty_mode][enable]');
            $(clone).find('#input-list-product-item-empty-mode-default-empty').attr('be_input_name', 'list_product[' + product_row_index + '][item_empty_mode][default_empty]');
            $(clone).find('#input-list-product-item-empty-mode-not-empty-in-cart').attr('be_input_name', 'list_product[' + product_row_index + '][item_empty_mode][not_empty_in_cart]');
            $(clone).find('[id^=input-list-product-item-empty-mode-title]').each(function (index, element) {
                var lng_id = $(element).attr('language-id');
                $(element).attr('be_input_name', 'list_product[' + product_row_index + '][item_empty_mode][title][' + lng_id + ']');
            })
            // for (var language_id in item_empty_mode_title){
            //     $(clone).find('#input-list-product-item-empty-mode-title'+language_id).attr('be_input_name', 'list_product['+product_row_index+'][item_empty_mode][title]['+language_id+']');
            // }

            $(clone).find('#input-list-product-item-hide-special-products').attr('be_input_name', 'list_product[' + product_row_index + '][hide_special_products]');
            $(clone).find('#input-list-product-item-products-combine-mode').attr('be_input_name', 'list_product[' + product_row_index + '][products_combine_mode]');
            $(clone).find('#input-list-product-item-products-randomize-select-product').attr('be_input_name', 'list_product[' + product_row_index + '][randomize_select_product]');

            $(clone).find('[id^=input-list-product-empty-group-image]').attr('be_input_name', 'list_product[' + product_row_index + '][empty_group_image]');
            $(clone).find('[id^=input-list-product-empty-group-image]').attr('id', 'input-list-product-empty-group-image-' + product_row_index);
            $(clone).find('[id^=empty-group-image-thumb]').attr('id', 'empty-group-image-thumb-' + product_row_index);


            $(clone).find('#input-list-product-item-position').attr('be_input_name', 'list_product[' + product_row_index + '][item_position]');
            $(clone).find('#input-list-product-name').attr('be_input_name', 'list_product[' + product_row_index + '][name]');
            $(clone).find('#input-list-product-item-id').attr('be_input_name', 'list_product[' + product_row_index + '][item_id]');
            $(clone).find('#input-list-product-item-value').attr('be_input_name', 'list_product[' + product_row_index + '][item_value]');
            $(clone).find('#input-list-product-item-type').attr('be_input_name', 'list_product[' + product_row_index + '][item_type]');
            $(clone).find('#input-list-product-main').attr('be_input_name', 'list_product[' + product_row_index + '][main]');
            $(clone).find('#input-list-product-has-options').attr('be_input_name', 'list_product[' + product_row_index + '][has_options]');
            $(clone).find('#input-list-product-remove-item-product ').attr('be_input_name', 'list_product[' + product_row_index + '][remove_item_product]');

            $(clone).find('#input-list-product-quantity').attr('be_input_name', 'list_product[' + product_row_index + '][quantity]');
            $(clone).find('#input-list-product-item-quantity-edit').attr('be_input_name', 'list_product[' + product_row_index + '][quantity_edit]');
            $(clone).find('#input-list-product-item-free-product-default-in-kit').attr('be_input_name', 'list_product[' + product_row_index + '][free_product_default_in_kit]');
            $(clone).find('#input-list-product-price-mode').attr('be_input_name', 'list_product[' + product_row_index + '][price_mode]');
            $(clone).find('#input-list-product-custom-field').attr('be_input_name', 'list_product[' + product_row_index + '][custom_field]');
            $(clone).find('#input-list-product-price').attr('be_input_name', 'list_product[' + product_row_index + '][price]');
            $(clone).find('#input-list-product-price-minus-sum').attr('be_input_name', 'list_product[' + product_row_index + '][price_minus_sum]');
            $(clone).find('#input-list-product-price-minus-percent').attr('be_input_name', 'list_product[' + product_row_index + '][price_minus_percent]');

            $(clone).find('#input-list-product-price-minus-percent').attr('be_input_name', 'list_product[' + product_row_index + '][price_minus_percent]');

            //15911
            // console.log("price_mode_to_customer_groups_status: " + price_mode_to_customer_groups_status);
            if (price_mode_to_customer_groups_status) {
                $(clone).find('#input-list-product-item-products-price-mode-to-customer-groups-status').val(1);
                $(clone).find('#input-list-product-item-products-price-mode-to-customer-groups-status').prop('checked', true);

                $(clone).find('.price-mode-to-customer-groups-container').show();

            } else {
                $(clone).find('#input-list-product-item-products-price-mode-to-customer-groups-status').val(0);
                $(clone).find('#input-list-product-item-products-price-mode-to-customer-groups-status').prop('checked', false);

                $(clone).find('.price-mode-to-customer-groups-container').hide();
            }

            $(clone).find('#input-list-product-item-products-price-mode-to-customer-groups-status').attr('be_input_name', 'list_product[' + product_row_index + '][price_mode_to_customer_groups_status]');


            for(var i=0;i<price_mode_to_customer_groups.length;i++){

                var price_mode_to_customer_group = price_mode_to_customer_groups[i];

                var group_row_clone = $('#price-mode-to-customer-groups-row-template .price-mode-to-customer-groups-row').clone();

                $(group_row_clone).removeClass('hidden');

                $(group_row_clone).find('#input-list-product-item-products-price-mode-to-customer-groups-customer-group-id').attr('be_input_name', 'list_product[' + product_row_index + '][price_mode_to_customer_groups]['+i+'][customer_group_id]');
                $(group_row_clone).find('#input-list-product-item-products-price-mode-to-customer-groups-price-mode').attr('be_input_name', 'list_product[' + product_row_index + '][price_mode_to_customer_groups]['+i+'][price_mode]');
                $(group_row_clone).find('#input-list-product-item-products-price-mode-to-customer-groups-value').attr('be_input_name', 'list_product[' + product_row_index + '][price_mode_to_customer_groups]['+i+'][value]');

                $(group_row_clone).find('#input-list-product-item-products-price-mode-to-customer-groups-customer-group-id').val(price_mode_to_customer_group['customer_group_id']);
                $(group_row_clone).find('#input-list-product-item-products-price-mode-to-customer-groups-price-mode').val(price_mode_to_customer_group['price_mode']);
                $(group_row_clone).find('#input-list-product-item-products-price-mode-to-customer-groups-value').val(price_mode_to_customer_group['value']);


                $(clone).find('.price-mode-to-customer-groups-container .price-mode-to-customer-group-add-button').before(group_row_clone);

                $(clone).find('.price-mode-to-customer-groups-container').attr("rows-count", i+1);
            }
            //15911

            if (store_status == 0) {
                $(clone).addClass('disabled-store-kit-item');
            }


            //Опции
            //Кнопка опций
            if (has_options === 'true' || has_options === '1') {
                $(clone).find('.options-button').css('display', 'inline-block');
                ;
            } else {
                $(clone).find('.options-button').hide();

            }
            //disable-options
            // var disable_options_info_string = "";
            for (var i = 0; i < $(disable_options).length; i++) {
                var disable_option = disable_options[i];
                var html = '';

                html += '<div id="disable-option' + i + '"><i class="fa fa-minus-circle"></i>' + disable_option['item_name'];
                html += '<input type="hidden" be_input_name="list_product[' + product_row_index + '][disable_options][' + i + '][item_type]" value="' + disable_option['item_type'] + '" />';
                html += '<input type="hidden" be_input_name="list_product[' + product_row_index + '][disable_options][' + i + '][product_option_id]" value="' + disable_option['product_option_id'] + '" />';
                html += '<input type="hidden" be_input_name="list_product[' + product_row_index + '][disable_options][' + i + '][option_id]" value="' + disable_option['option_id'] + '" />';
                html += '<input type="hidden" be_input_name="list_product[' + product_row_index + '][disable_options][' + i + '][product_option_value_id]" value="' + disable_option['product_option_value_id'] + '" />';
                html += '<input type="hidden" be_input_name="list_product[' + product_row_index + '][disable_options][' + i + '][option_value_id]" value="' + disable_option['option_value_id'] + '" />';
                html += '<input type="hidden" be_input_name="list_product[' + product_row_index + '][disable_options][' + i + '][name]" id="input-option-name" value="' + disable_option['name'] + '" />';
                html += '</div>';

                $(clone).find('#disable-options').append(html);

                // disable_options_info_string += disable_option['item_name'] + "; ";
            }

            $(clone).find('#disable-options').attr('last-index', $(disable_options).length);

            init_autocomplete_disable_options($(clone).find('#input-disable-options').first());

            $(clone).find('#disable-options').delegate('.fa-minus-circle', 'click', function () {
                $(this).parent().remove();
                update_options_short_info();
            });

            //enabled-options
            // var enabled_options_info_string = "";
            for (var i = 0; i < $(enabled_options).length; i++) {
                var enabled_option = enabled_options[i];
                var html = '';

                html += '<div id="enabled-option' + i + '"><i class="fa fa-minus-circle"></i>' + enabled_option['item_name'];
                html += '<input type="hidden" be_input_name="list_product[' + product_row_index + '][enabled_options][' + i + '][item_type]" value="' + enabled_option['item_type'] + '" />';
                html += '<input type="hidden" be_input_name="list_product[' + product_row_index + '][enabled_options][' + i + '][product_option_id]" value="' + enabled_option['product_option_id'] + '" />';
                html += '<input type="hidden" be_input_name="list_product[' + product_row_index + '][enabled_options][' + i + '][option_id]" value="' + enabled_option['option_id'] + '" />';
                html += '<input type="hidden" be_input_name="list_product[' + product_row_index + '][enabled_options][' + i + '][product_option_value_id]" value="' + enabled_option['product_option_value_id'] + '" />';
                html += '<input type="hidden" be_input_name="list_product[' + product_row_index + '][enabled_options][' + i + '][option_value_id]" value="' + enabled_option['option_value_id'] + '" />';
                html += '<input type="hidden" be_input_name="list_product[' + product_row_index + '][enabled_options][' + i + '][name]" id="input-option-name" value="' + enabled_option['name'] + '" />';
                html += '</div>';

                $(clone).find('#enabled-options').append(html);

                // enabled_options_info_string += enabled_option['item_name'] + "; ";
            }

            $(clone).find('#enabled-options').attr('last-index', $(enabled_options).length);

            init_autocomplete_enabled_options($(clone).find('#input-enabled-options').first());

            $(clone).find('#enabled-options').delegate('.fa-minus-circle', 'click', function () {
                $(this).parent().remove();
                update_options_short_info();
            });

            //fixed-options
            // var fixed_options_info_string = "";
            for (var i = 0; i < $(fixed_options).length; i++) {
                var fixed_option = fixed_options[i];
                var html = '';

                html += '<div id="fixed-option' + i + '"><i class="fa fa-minus-circle"></i>' + fixed_option['item_name'];
                html += '<input type="hidden" be_input_name="list_product[' + product_row_index + '][fixed_options][' + i + '][item_type]" value="' + fixed_option['item_type'] + '" />';
                html += '<input type="hidden" be_input_name="list_product[' + product_row_index + '][fixed_options][' + i + '][product_option_id]" value="' + fixed_option['product_option_id'] + '" />';
                html += '<input type="hidden" be_input_name="list_product[' + product_row_index + '][fixed_options][' + i + '][option_id]" value="' + fixed_option['option_id'] + '" />';
                html += '<input type="hidden" be_input_name="list_product[' + product_row_index + '][fixed_options][' + i + '][product_option_value_id]" value="' + fixed_option['product_option_value_id'] + '" />';
                html += '<input type="hidden" be_input_name="list_product[' + product_row_index + '][fixed_options][' + i + '][option_value_id]" value="' + fixed_option['option_value_id'] + '" />';
                html += '<input type="hidden" be_input_name="list_product[' + product_row_index + '][fixed_options][' + i + '][name]" id="input-option-name" value="' + fixed_option['name'] + '" />';
                html += '</div>';

                $(clone).find('#fixed-options').append(html);

                // fixed_options_info_string += fixed_option['item_name'] + "; ";

            }

            $(clone).find('#fixed-options').attr('last-index', $(fixed_options).length);

            // $(clone).find('#fixed-options').html(disable_options_info_string);

            // if($(fixed_options).length>0)
            //     $(clone).find('#fixed-options').html(fixed_options_info_string);

            init_autocomplete_fixed_options($(clone).find('#input-fixed-options').first());

            $(clone).find('#fixed-options').delegate('.fa-minus-circle', 'click', function () {
                $(this).parent().remove();
                update_options_short_info();
            });
            //Опции


            if (main === '1')
                $('#kit-product-main-content').append(clone);
            else {
                init_autocomplete($(clone).find('#input-list-product-name-filter').first());

                //Если такая группа товаров уже есть, то добавляем в конец
                var el = $('#kit-product-list #kit-product-list-content .kit-product-list-item[item-position=' + item_position + ']').last();
                if (el.length > 0)
                    $(el).after(clone);
                else
                    $('#kit-product-list #kit-product-list-content').append(clone);
            }


            $(clone).show();

            if (main === '1') {
                // $('#kit-product-main-content .column-item-mode').children().hide();
                $('#kit-product-main-content .column-item-mode').hide();
                // $('#kit-product-main-content .column-filter-name').removeClass('col-sm-4').addClass('col-sm-6');
            }

        }

        function delete_product(element) {
            update_items_empty_group_images();//Вызываем дополнительно здесь, т.к. при смене картинки обработчик не работает

            $(element).closest('.kit-product-list-item').remove();

            update_items_positions();
            update_views();
        }

        //Перемещаем элемент комплекта вверх либо по позиции, либо среди позиций
        function move_up(element) {
            update_items_empty_group_images();//Вызываем дополнительно здесь, т.к. при смене картинки обработчик не работает

            var row = $(element).closest('tr');
            var item_position = parseInt($(row).attr('item-position'));
            var items_rows = $('#kit-product-list').find('tr.kit-product-list-item[item-position=' + item_position + ']');

            //Если первый элемент среди группы, то перемещаем по позициям, причем сразу все элементы позиции
            //Иначе перемещаем внутри группы
            if ($(items_rows).first().is(row)) {
                var prev_item_position = item_position - 1;
                var items = $('#kit-product-list').find('tr.kit-product-list-item[item-position=' + item_position + ']');
                var prev_main_item = $('#kit-product-list').find('tr.kit-product-list-item[item-position=' + prev_item_position + ']').first();
                if ($(prev_main_item).length > 0) {
                    $(prev_main_item).before(items);
                    update_items_positions();
                    update_views();
                    return;
                }
            } else {
                var prev_row = $(element).closest('tr').prev();

                var element_pos = $(row).attr('item-position')
                var prev_element_pos = $(prev_row).attr('item-position');

                $(prev_row).before(row);
                update_items_positions();
                update_views();
                return;

            }

        }

        //Перемещаем элемент комплекта вниз либо по позиции, либо среди позиций
        function move_down(element) {
            update_items_empty_group_images();//Вызываем дополнительно здесь, т.к. при смене картинки обработчик не работает

            var row = $(element).closest('tr');
            var item_position = parseInt($(row).attr('item-position'));
            var items_rows = $('#kit-product-list').find('tr.kit-product-list-item[item-position=' + item_position + ']');

            //Если первый элемент среди группы, то перемещаем по позициям, причем сразу все элементы позиции
            //Иначе перемещаем внутри группы
            if ($(items_rows).first().is(row)) {
                var next_item_position = item_position + 1;
                var items = $('#kit-product-list').find('tr.kit-product-list-item[item-position=' + item_position + ']');
                var next_last_item = $('#kit-product-list').find('tr.kit-product-list-item[item-position=' + next_item_position + ']').last();
                if ($(next_last_item).length > 0) {
                    $(next_last_item).after(items);
                    update_items_positions();
                    update_views();
                    return;
                }
            } else {
                var next_row = $(element).closest('tr').next();

                var element_pos = $(row).attr('item-position')
                var next_element_pos = $(next_row).attr('item-position');

                $(next_row).after(row);
                update_items_positions();
                update_views();
                return;

            }
        }

        // function create_dropdown_list(list) {
        //
        //     var items = $.map(list, function (item, index) {
        //         return {
        //             label: item['name'],
        //             name: item['name'],
        //             value: index,
        //             item_id: item['item_id'],
        //             item_value: item['item_value'],
        //             has_options: item['has_options'],
        //             type: item['type']
        //         }
        //     });
        //
        //
        //     var dropdown = '';
        //
        //     dropdown = $('.dropdown-list-template').clone();
        //
        //     dropdown =  $(dropdown).find('.dropdown-template');
        //     $(dropdown).addClass('dropdown');
        //     $(dropdown).removeClass('dropdown-template');
        //
        //     var item_template = $('.dropdown-item-template div').first().clone();
        //
        //     for(i=0;i<items.length;i++){
        //         var item = items[i];
        //
        //         var item_clone = $(item_template).clone();
        //
        //         $(item_clone).find('.item-text').html(item.label);
        //
        //         var checkbox = $(item_clone).find('.form-check-input');
        //         var label = $(item_clone).find('.form-check-label');
        //
        //         $(checkbox).attr('id', "defaultCheck"+i);
        //
        //         $(checkbox).attr('data-value', item.value);
        //         $(checkbox).attr('data-item-id', item.item_id);
        //         $(checkbox).attr('data-item-value', item.item_value);
        //         $(checkbox).attr('data-has-options', item.has_options);
        //         $(checkbox).attr('data-type', item.type);
        //
        //
        //         $(label).attr('for', "defaultCheck"+i);
        //
        //         $(dropdown).find('.dropdown-menu-items').append(item_clone);
        //
        //     }
        //
        //     return dropdown;
        // }
        //
        // function dropdown_add_items_to_table(dropdown, click_element) {
        //
        //
        //     var element = $(dropdown).closest('td').find('#input-list-product-name-filter');
        //
        //     if (typeof click_element !== 'undefined') {
        //         var checked = $(click_element).closest('.form-check').find('input');
        //     }else {
        //         var checked = $(dropdown).find('input:checked');
        //
        //     }
        //
        //     for(i=0;i<checked.length;i++){
        //         var checkbox = checked[i];
        //
        //         var item = [];
        //
        //         item.label = $(checkbox).closest('.form-check').find('.item-text').html();
        //         item.value = $(checkbox).attr('data-value');
        //         item.item_id = $(checkbox).attr('data-item-id');
        //         item.item_value = $(checkbox).attr('data-item-value');
        //         item.has_options = $(checkbox).attr('data-has-options');
        //         item.type = $(checkbox).attr('data-type');
        //
        //         $(element).val(item['label']);
        //
        //         var product_row = $(element).closest('.kit-product-list-item');
        //
        //         $(product_row).attr('item-id', item['item_id']);
        //
        //         $(product_row).find('input, select').each(function (index, value) {
        //             var name = $(value).attr('be_input_name');
        //             $(value).attr('be_input_name', name)
        //         })
        //
        //         $(product_row).find('#input-list-product-name').val(item['name']);
        //         $(product_row).find('#input-list-product-item-id').val(item['item_id']);
        //         $(product_row).find('#input-list-product-item-value').val(item['item_value']);
        //         $(product_row).find('#input-list-product-item-type').val(item['type']);
        //         $(product_row).find('#input-list-product-has-options').val(item['has_options']);
        //
        //         //Сбрасываем настройки опций
        //         $(product_row).find('#disable-options').html('');
        //         $(product_row).find('#fixed-options').html('');
        //
        //         update_views();
        //
        //     }
        // }
        //
        // function dropdown_item_click(element){
        //
        //     var dropdown = $(element).closest('.dropdown-menu');
        //     var checkbox = $(element).find('input');
        //
        //     //Если не выбраны другие чекбоксы, то сразу добавляем
        //     var checked = $(dropdown).find('input:checked').length;
        //
        //     if(checked===0){
        //         dropdown_add_items_to_table(dropdown, element);
        //     }
        //
        //
        //
        //
        // }
        //
        // function remove_dropdowns(){
        //     $('.dropdown').replaceWith('');
        // }

        //function show_dropdown(element) {
        //    var item_mode = $(element).closest('.kit-product-list-item').find('#input-list-product-item-mode :selected').val();
        //
        //    if (item_mode === 'fix_product')
        //        filter_only_product = 1;
        //    else
        //        filter_only_product = 0;
        //
        //    var input_element = element;
        //
        //    remove_dropdowns();
        //
        //    var filter_name = $(element).val();
        //
        //    $.ajax({
        //        url: 'index.php?route=catalog/bundle_expert_kit/autocomplete_product&{# echo $token_name; #}<!---->{# echo $token_value; #}//&filter_name=' + encodeURIComponent(filter_name) + '&filter_only_product=' + filter_only_product,
        //        dataType: 'json',
        //        success: function (json) {
        //            if ($(input_element).is(":focus")) {
        //
        //                var dropdown_element = create_dropdown_list(json);
        //
        //                $(dropdown_element).insertAfter(input_element);
        //
        //                var dropdown_button = $(dropdown_element).find('.dropdown-toggle');
        //
        //                $(dropdown_button).dropdown();
        //
        //                $(dropdown_button).dropdown('toggle');
        //
        //            } else {
        //                var dropdown_element = create_dropdown_list(json);
        //
        //                $(dropdown_element).insertAfter(input_element);
        //
        //                var dropdown_button = $(dropdown_element).find('.dropdown-toggle');
        //
        //                $(dropdown_button).dropdown();
        //
        //                $(dropdown_button).dropdown('toggle');
        //
        //                false;
        //            }
        //        }
        //    });
        //}

        function add_group_to_item_as_products(group, item_position, row_index, item_mode) {
            var group_id = group['item_id'];

            $.ajax({
                url: 'index.php?route=catalog/bundle_expert_product_group/get_group_products_list&{{ token_name }}{{ token_value }}&group_id=' + group_id,
                dataType: 'json',
                success: function (json) {

                    if(json['products']){
                        // var item_position = $(product_row).find('input#input-list-product-item-position').val();
                        // var item_position = $(product_row).attr('item-position');

                        var first_element='';

                        for(var i=0;i<json['products'].length;i++){
                            var item = json['products'][i];
                            item['label'] = item['name'];

                            var element;

                            //Первый товар вставляем в уже имеющуюся позицию
                            //Для остальных создаём новые
                            if(i>0){
                                // var item_mode =$('#kit-product-list-content').find('tr.kit-product-list-item[item-position='+item_position+'][row-index='+row_index+']').last().next().attr('item-mode');;
                                add_new_product_select(item_position, item_mode);
                                element = $('#kit-product-list-content').find('tr.kit-product-list-item[item-position='+item_position+'] #input-list-product-name-filter').last();

                            }else{
                                element = $('#kit-product-list-content').find('tr.kit-product-list-item[item-position='+item_position+'][row-index='+row_index+'] #input-list-product-name-filter').last();
                            }

                            //Аналог кода из function init_autocomplete(element) {
                            $(element).val(item['label']);

                            var product_row = $(element).closest('.kit-product-list-item');

                            $(product_row).attr('item-id', item['item_id']);

                            $(product_row).find('input, select').each(function (index, value) {
                                var name = $(value).attr('be_input_name');
                                //name = name.replace('item_id', item['value']);
                                $(value).attr('be_input_name', name)
                            })

                            $(product_row).find('#input-list-product-name').val(item['name']);
                            $(product_row).find('#input-list-product-item-id').val(item['item_id']);
                            $(product_row).find('#input-list-product-item-value').val(item['item_value']);
                            $(product_row).find('#input-list-product-item-type').val(item['type']);
                            $(product_row).find('#input-list-product-has-options').val(item['has_options']);

                            //Сбрасываем настройки опций
                            $(product_row).find('#disable-options').html('');
                            $(product_row).find('#fixed-options').html('');

                            if(i==0){
                                first_element = product_row;
                            }

                            //Копируем настройки первого элемента
                            if(i>0 && first_element!==''){
                                var default_in_kit = $(first_element).find('#input-list-product-item-free-product-default-in-kit').val();
                                var default_in_kit_checked = $(first_element).find('#input-list-product-item-free-product-default-in-kit').prop('checked');
                                var quantity = $(first_element).find('#input-list-product-quantity').val();
                                var quantity_edit = $(first_element).find('#input-list-product-item-quantity-edit').val();
                                var quantity_edit_checked = $(first_element).find('#input-list-product-item-quantity-edit').prop('checked');
                                var price_mode = $(first_element).find('#input-list-product-price-mode').val();
                                var custom_field = $(first_element).find('#input-list-product-custom-field').val();
                                var price_minus_sum = $(first_element).find('#input-list-product-price-minus-sum').val();
                                var price_minus_percent = $(first_element).find('#input-list-product-price-minus-percent').val();
                                var price_price = $(first_element).find('#input-list-product-price').val();

                                $(product_row).find('#input-list-product-item-free-product-default-in-kit').val(default_in_kit);
                                $(product_row).find('#input-list-product-item-free-product-default-in-kit').prop('checked', default_in_kit_checked);
                                $(product_row).find('#input-list-product-quantity').val(quantity);
                                $(product_row).find('#input-list-product-item-quantity-edit').val(quantity_edit);
                                $(product_row).find('#input-list-product-item-quantity-edit').prop('checked', quantity_edit_checked);
                                $(product_row).find('#input-list-product-price-mode').val(price_mode);
                                $(product_row).find('#input-list-product-custom-field').val(custom_field);
                                $(product_row).find('#input-list-product-price-minus-sum').val(price_minus_sum);
                                $(product_row).find('#input-list-product-price-minus-percent').val(price_minus_percent);
                                $(product_row).find('#input-list-product-price').val(price_price);
                            }



                            update_views();

                        }
                    }


                }
            });
        }

        function add_group_to_link_products_as_products(group) {

            var group_id = group['item_id'];

            $.ajax({
                url: 'index.php?route=catalog/bundle_expert_product_group/get_group_products_list&{{ token_name }}{{ token_value }}&group_id=' + group_id,
                dataType: 'json',
                success: function (json) {

                    if(json['products']){
                        for(var i=0;i<json['products'].length;i++){
                            var product = json['products'][i];
                            product['label'] = product['name'];
                            add_product_to_link_products(product);
                        }
                    }

                    update_main_products();

                }
            });
        }

        function init_autocomplete(element) {
            //В щаблонгах импорта инициализация не нужна
            if ($('#import-template-main-container').length > 0) {
                return;
            }

            var multiselect = true;
            var multiselect = false;

            if(multiselect){
                // $(element).keyup(function () {
                //     show_dropdown(element);
                // });
                // $(element).focusin(function () {
                //     show_dropdown(element);
                // });
            }else{
                $(element).autocomplete({
                    'source': function (request, response) {
                        var item_mode = $(this).closest('.kit-product-list-item').find('#input-list-product-item-mode :selected').val();

                        if (item_mode === 'fix_product')
                            filter_only_product = 1;
                        else
                            filter_only_product = 0;

                        var kit_id = $('input[name=kit_id]').val();

                        var input_element = this;

                        //15913
                        var kit_mode = $('select#input-kit-mode').val();
                        if (kit_mode === 'auto_list')
                            filter_only_product = 0;
                        // else
                        //     filter_only_product = 0;
                        //15913

                        $.ajax({
                            {#url: 'index.php?route=catalog/bundle_expert_kit/autocomplete_product&{{ token_name }}{{ token_value }}&filter_name=' + encodeURIComponent(request) + '&filter_only_product=' + filter_only_product + '&kit_id=' + kit_id,#}
                            url: 'index.php?route=catalog/bundle_expert_kit/autocomplete_product&{{ token_name }}{{ token_value }}&filter_name=' + encodeURIComponent(request) + '&filter_only_product=' + filter_only_product + '&kit_id=' + kit_id + '&kit_mode=' + kit_mode,
                            dataType: 'json',
                            success: function (json) {
                                if ($(input_element).is(":focus")) {
                                    response($.map(json, function (item, index) {
                                        return {
                                            label: item['name'],
                                            name: item['name'],
                                            value: index,
                                            item_id: item['item_id'],
                                            item_value: item['item_value'],
                                            has_options: item['has_options'],
                                            custom_parameter: item['custom_parameter'],
                                            type: item['type']
                                        }
                                    }));
                                } else {
                                    false;
                                }
                            }
                        });
                    },
                    'select': function (item) {

                        //Если надо добавить группу отдельными товарами
                        if(item['custom_parameter']==="add_group_as_products"){
                            var item_position = $(element).closest('.kit-product-list-item').attr('item-position');
                            var row_index = $(element).closest('.kit-product-list-item').attr('row-index');
                            var item_mode = $(element).closest('.kit-product-list-item').find('select#input-list-product-item-mode').val();
                            add_group_to_item_as_products(item, item_position, row_index, item_mode);
                            return;
                        }

                        $(element).val(item['label']);

                        var product_row = $(element).closest('.kit-product-list-item');

                        $(product_row).attr('item-id', item['item_id']);

                        $(product_row).find('input, select').each(function (index, value) {
                            var name = $(value).attr('be_input_name');
                            //name = name.replace('item_id', item['value']);
                            $(value).attr('be_input_name', name)
                        })

                        $(product_row).find('#input-list-product-name').val(item['name']);
                        $(product_row).find('#input-list-product-item-id').val(item['item_id']);
                        $(product_row).find('#input-list-product-item-value').val(item['item_value']);
                        $(product_row).find('#input-list-product-item-type').val(item['type']);
                        $(product_row).find('#input-list-product-has-options').val(item['has_options']);

                        //Сбрасываем настройки опций
                        $(product_row).find('#disable-options').html('');
                        $(product_row).find('#fixed-options').html('');



                        update_views();

                    }
                });
            }



        }

        function init_autocomplete_disable_options(element) {
            $(element).autocomplete({
                'source': function (request, response) {
                    var product_id = $(element).closest('.kit-product-list-item').attr('item-id');

                    var data = $(element).closest('.kit-product-list-item').find('#disable-options input').serializeArray();

                    data = $(data).add({name: 'product_id', value: product_id});
                    data = $(data).add({name: 'filter_name', value: encodeURIComponent(request)});

                    $.ajax({
                        //url: 'index.php?route=catalog/bundle_expert_kit/autocomplete_disable_option&{{ token_name }}{# echo $token_value; #}//&filter_name=' +  encodeURIComponent(request) + '&product_id=' +  product_id + '&filter_list=' +  filter_list2,
                        url: 'index.php?route=catalog/bundle_expert_kit/autocomplete_disable_option&{{ token_name }}{{ token_value }}',
                        type: 'post',
                        data: data,
                        dataType: 'json',
                        success: function (json) {
                            response($.map(json, function (item, index) {
                                return {
                                    product_option_id: item['product_option_id'],
                                    option_id: item['option_id'],
                                    product_option_value_id: item['product_option_value_id'],
                                    option_value_id: item['option_value_id'],
                                    item_type: item['item_type'],
                                    name: item['name'],

                                    label: item['item_name'],
                                    value: index,
                                }
                            }));
                        }
                    });
                },
                'select': function (item) {

                    var disable_options = $(element).parent().find('#disable-options');

                    var last_index = $(disable_options).attr('last-index');

                    var i = last_index;

                    $(element).val('');

                    var row_index = $(element).closest('.kit-product-list-item').attr('row-index');

                    var html = '';
                    html += '<div id="disable-option' + i + '"><i class="fa fa-minus-circle"></i>' + item['label'];
                    html += '<input type="hidden" be_input_name="list_product[' + row_index + '][disable_options][' + i + '][item_type]" value="' + item['item_type'] + '" />';
                    html += '<input type="hidden" be_input_name="list_product[' + row_index + '][disable_options][' + i + '][product_option_id]" value="' + item['product_option_id'] + '" />';
                    html += '<input type="hidden" be_input_name="list_product[' + row_index + '][disable_options][' + i + '][option_id]" value="' + item['option_id'] + '" />';
                    html += '<input type="hidden" be_input_name="list_product[' + row_index + '][disable_options][' + i + '][product_option_value_id]" value="' + item['product_option_value_id'] + '" />';
                    html += '<input type="hidden" be_input_name="list_product[' + row_index + '][disable_options][' + i + '][option_value_id]" value="' + item['option_value_id'] + '" />';
                    html += '<input type="hidden" be_input_name="list_product[' + row_index + '][disable_options][' + i + '][name]" id="input-option-name" value="' + item['name'] + '" />';
                    html += '</div>';

                    // $(disable_options).find('#link-product' + item['value']).remove();//TODO удаление предыдущего такого элемента

                    $(disable_options).append(html);

                    last_index++;
                    $(disable_options).attr('last-index', last_index);

                    update_options_short_info();
                }
            });
        }



        function init_autocomplete_enabled_options(element) {
            $(element).autocomplete({
                'source': function (request, response) {
                    var product_id = $(element).closest('.kit-product-list-item').attr('item-id');

                    var data = $(element).closest('.kit-product-list-item').find('#enabled-options input').serializeArray();

                    data = $(data).add({name: 'product_id', value: product_id});
                    data = $(data).add({name: 'filter_name', value: encodeURIComponent(request)});

                    $.ajax({
                        //url: 'index.php?route=catalog/bundle_expert_kit/autocomplete_disable_option&{{ token_name }}{# echo $token_value; #}//&filter_name=' +  encodeURIComponent(request) + '&product_id=' +  product_id + '&filter_list=' +  filter_list2,
                        url: 'index.php?route=catalog/bundle_expert_kit/autocomplete_enabled_option&{{ token_name }}{{ token_value }}',
                        type: 'post',
                        data: data,
                        dataType: 'json',
                        success: function (json) {
                            response($.map(json, function (item, index) {
                                return {
                                    product_option_id: item['product_option_id'],
                                    option_id: item['option_id'],
                                    product_option_value_id: item['product_option_value_id'],
                                    option_value_id: item['option_value_id'],
                                    item_type: item['item_type'],
                                    name: item['name'],

                                    label: item['item_name'],
                                    value: index,
                                }
                            }));
                        }
                    });
                },
                'select': function (item) {

                    var enabled_options = $(element).parent().find('#enabled-options');

                    var last_index = $(enabled_options).attr('last-index');

                    var i = last_index;

                    $(element).val('');

                    var row_index = $(element).closest('.kit-product-list-item').attr('row-index');

                    var html = '';
                    html += '<div id="enabled-option' + i + '"><i class="fa fa-minus-circle"></i>' + item['label'];
                    html += '<input type="hidden" be_input_name="list_product[' + row_index + '][enabled_options][' + i + '][item_type]" value="' + item['item_type'] + '" />';
                    html += '<input type="hidden" be_input_name="list_product[' + row_index + '][enabled_options][' + i + '][product_option_id]" value="' + item['product_option_id'] + '" />';
                    html += '<input type="hidden" be_input_name="list_product[' + row_index + '][enabled_options][' + i + '][option_id]" value="' + item['option_id'] + '" />';
                    html += '<input type="hidden" be_input_name="list_product[' + row_index + '][enabled_options][' + i + '][product_option_value_id]" value="' + item['product_option_value_id'] + '" />';
                    html += '<input type="hidden" be_input_name="list_product[' + row_index + '][enabled_options][' + i + '][option_value_id]" value="' + item['option_value_id'] + '" />';
                    html += '<input type="hidden" be_input_name="list_product[' + row_index + '][enabled_options][' + i + '][name]" id="input-option-name" value="' + item['name'] + '" />';
                    html += '</div>';

                    // $(enabled_options).find('#link-product' + item['value']).remove();//TODO удаление предыдущего такого элемента

                    $(enabled_options).append(html);

                    last_index++;
                    $(enabled_options).attr('last-index', last_index);

                    update_options_short_info();
                }
            });
        }

        function add_product_to_link_products(item) {
            link_product_row_index++;

            $('input[name=\'link_product_name\']').val('');

            $('#link-product').append('<div id="link-product' + link_product_row_index + '"><i class="fa fa-minus-circle"></i> ' + item['label'] + '<input type="hidden" name="link_product[' + link_product_row_index + '][item_type]" value="' + item['type'] + '" /> <input type="hidden" name="link_product[' + link_product_row_index + '][item_id]" value="' + item['item_id'] + '" /> <input type="hidden" name="link_product[' + link_product_row_index + '][item_value]" value="' + item['item_value'] + '" /><input type="hidden" name="link_product[' + link_product_row_index + '][name]" value="' + item['label'] + '" /><input type="hidden" name="link_product[' + link_product_row_index + '][has_options]" value="' + item['has_options'] + '" /></div>');


        }

        function init_autocomplete_fixed_options(element) {
            $(element).autocomplete({
                'source': function (request, response) {
                    var product_id = $(element).closest('.kit-product-list-item').attr('item-id');

                    var data = $(element).closest('.kit-product-list-item').find('#fixed-options input').serializeArray();

                    data = $(data).add({name: 'product_id', value: product_id});
                    data = $(data).add({name: 'filter_name', value: encodeURIComponent(request)});

                    $.ajax({
                        //url: 'index.php?route=catalog/bundle_expert_kit/autocomplete_fixed_option&{{ token_name }}{# echo $token_value; #}//&filter_name=' +  encodeURIComponent(request) + '&product_id=' +  product_id,
                        url: 'index.php?route=catalog/bundle_expert_kit/autocomplete_fixed_option&{{ token_name }}{{ token_value }}',
                        type: 'post',
                        data: data,
                        dataType: 'json',
                        success: function (json) {
                            response($.map(json, function (item, index) {
                                return {
                                    product_option_id: item['product_option_id'],
                                    option_id: item['option_id'],
                                    product_option_value_id: item['product_option_value_id'],
                                    option_value_id: item['option_value_id'],
                                    item_type: item['item_type'],
                                    name: item['name'],

                                    label: item['item_name'],
                                    value: index,
                                }
                            }));
                        }
                    });
                },
                'select': function (item) {

                    var fixed_options = $(element).parent().find('#fixed-options');

                    var last_index = $(fixed_options).attr('last-index');

                    var i = last_index;

                    $(element).val('');

                    var row_index = $(element).closest('.kit-product-list-item').attr('row-index');

                    var html = '';
                    html += '<div id="fixed-option' + i + '"><i class="fa fa-minus-circle"></i>' + item['label'];
                    html += '<input type="hidden" be_input_name="list_product[' + row_index + '][fixed_options][' + i + '][item_type]" value="' + item['item_type'] + '" />';
                    html += '<input type="hidden" be_input_name="list_product[' + row_index + '][fixed_options][' + i + '][product_option_id]" value="' + item['product_option_id'] + '" />';
                    html += '<input type="hidden" be_input_name="list_product[' + row_index + '][fixed_options][' + i + '][option_id]" value="' + item['option_id'] + '" />';
                    html += '<input type="hidden" be_input_name="list_product[' + row_index + '][fixed_options][' + i + '][product_option_value_id]" value="' + item['product_option_value_id'] + '" />';
                    html += '<input type="hidden" be_input_name="list_product[' + row_index + '][fixed_options][' + i + '][option_value_id]" value="' + item['option_value_id'] + '" />';
                    html += '<input type="hidden" be_input_name="list_product[' + row_index + '][fixed_options][' + i + '][name]" id="input-option-name" value="' + item['name'] + '" />';
                    html += '</div>';

                    // $(disable_options).find('#link-product' + item['value']).remove();//TODO удаление предыдущего такого элемента

                    $(fixed_options).append(html);

                    last_index++;
                    $(fixed_options).attr('last-index', last_index);

                    update_options_short_info();
                }
            });
        }

        //main product autcomplete
        $('input[name=\'link_product_name\']').autocomplete({
            'source': function (request, response) {

                //В щаблонгах импорта инициализация не нужна
                if ($('#import-template-main-container').length > 0) {
                    return;
                }

                filter_only_product = 0;

                var input_element = this;

                var kit_id = $('input[name=kit_id]').val();

                $.ajax({
                    url: 'index.php?route=catalog/bundle_expert_kit/autocomplete_product&{{ token_name }}{{ token_value }}&filter_name=' + encodeURIComponent(request) + '&filter_only_product=' + filter_only_product + '&kit_id=' + kit_id,
                    dataType: 'json',
                    success: function (json) {
                        if ($(input_element).is(":focus")) {
                            response($.map(json, function (item, index) {
                                return {
                                    label: item['name'],
                                    value: index,
                                    item_id: item['item_id'],
                                    item_value: item['item_value'],
                                    has_options: item['has_options'],
                                    custom_parameter: item['custom_parameter'],
                                    type: item['type']
                                }
                            }));
                        } else {
                            false;
                        }
                        // response($.map(json, function(item, index) {
                        //     return {
                        //         label: item['name'],
                        //         value: index,
                        //         item_id: item['item_id'],
                        //         has_options: item['has_options'],
                        //         type: item['type']
                        //     }
                        // }));
                    }
                });
            },
            'select': function (item) {

                //Если надо добавить группу отдельными товарами
                if(item['custom_parameter']==="add_group_as_products"){
                    add_group_to_link_products_as_products(item);

                    return;
                }

                add_product_to_link_products(item)

                update_main_products();
                // link_product_row_index++;
                //
                // $('input[name=\'link_product_name\']').val('');
                //
                // //$('#link-product' + item['value']).remove();
                //
                // $('#link-product').append('<div id="link-product' + link_product_row_index + '"><i class="fa fa-minus-circle"></i> ' + item['label'] + '<input type="hidden" name="link_product[' + link_product_row_index + '][item_type]" value="' + item['type'] + '" /> <input type="hidden" name="link_product[' + link_product_row_index + '][item_id]" value="' + item['item_id'] + '" /> <input type="hidden" name="link_product[' + link_product_row_index + '][item_value]" value="' + item['item_value'] + '" /><input type="hidden" name="link_product[' + link_product_row_index + '][name]" value="' + item['label'] + '" /><input type="hidden" name="link_product[' + link_product_row_index + '][has_options]" value="' + item['has_options'] + '" /></div>');
                //
                // update_main_products();
            }
        });

        $('#link-product').delegate('.fa-minus-circle', 'click', function () {
            $(this).parent().remove();

            update_main_products();
        });

        on_change_kit_as_product_field();

        function on_change_main_mode(element) {

            if ($(element).val() == "kit") {
                $('.panel-body').addClass('main-mode-kits');
                $('.panel-body').removeClass('main-mode-series');
            } else {
                $('.panel-body').addClass('main-mode-series');
                $('.panel-body').removeClass('main-mode-kits');

            }

            //15913
            if($(element).val()=='series' || $(element).val()=='collection'){
                $('select#input-kit-mode option[value=auto_list]').removeAttr('hidden');
            }else{
                $('select#input-kit-mode option[value=auto_list]').attr('hidden', 'hidden');
                $('select#input-kit-mode option[value=auto_list]').removeAttr('selected');
            }
            update_views();
            //15913

        }

        //15913
        function update_list_product_select_mode() {
            // Если режим коллекции или серии, то оставляем только выбор Свободных позиции
            if($('select[name=main_mode]').val()=='series' || $('input[name=main_mode]').val()=='collection'){
                $('#kit-product-list select#input-list-product-item-mode option[value=fix_product]').attr('hidden', 'hidden');
                $('#kit-product-list select#input-list-product-item-mode option[value=select_product]').attr('hidden', 'hidden');

                $('#kit-product-list .kit-product-list-item').each(function (index, element) {
                    if($(element).find('input#input-list-product-remove-item-product').val()=="1"){
                        return;
                    }
                    var select_element = $(element).find('select#input-list-product-item-mode');
                    $(select_element).val('free_product');
                    // on_item_mode_changed(select_element);
                })

            }else{
                $('#kit-product-list select#input-list-product-item-mode option[value=fix_product]').removeAttr('hidden');
                $('#kit-product-list select#input-list-product-item-mode option[value=select_product]').removeAttr('hidden');
            }
        }
        //15913

        function on_change_kit_as_product_field() {
            var element = $('select[name=kit_as_product]').first();
            var value = parseInt($(element).val());
            if (value == 1) {
                $('.save-kit-as-product-total-container').show();
                $('.kit-in-cart-as-product-container').show();
                $('.product-as-kit-light-mode-container').hide();
                // $('.kit-in-cart-as-product-container').show();
                // $('select[name=product_discount_in_total]').val(0);
            } else {
                $('.save-kit-as-product-total-container').hide();
                $('.kit-in-cart-as-product-container').hide();
                $('.product-as-kit-light-mode-container').show();

                // $('.kit-in-cart-as-product-container').hide();
                // $('select[name=save_kit_as_product_total]').val(0);
                $('select[name=kit_in_cart_as_product]').val(0);
            }

            update_product_as_lit_save_price();
            update_views_main_product_list();
            update_kit_as_product_main_product_use_default_discount();
        };

        function on_change_kit_as_product_field_light_mode() {
            update_product_as_lit_save_price();
            update_main_products();
        };

        function update_product_as_lit_save_price() {
            var element1 = $('select[name=kit_as_product]').first();
            var value1 = parseInt($(element1).val());
            var element2 = $('select[name=kit_as_product_light_mode]').first();
            var value2 = parseInt($(element2).val());
            if (value1 == 1 || value2 == 1) {
                $('.save-kit-as-product-total-container').show();
            } else {
                $('.save-kit-as-product-total-container').hide();
                $('select[name=save_kit_as_product_total]').val(0);
            }
        };

        //15911
        function init_add_products(){
            var kit_products_json = '{{ kit_products_json_encode }}';


            var json = JSON.parse(kit_products_json);

            for (var i = 0; i < json.length; i++) {
                add_product(
                    json[i]['item_id'],
                    json[i]['item_value'],
                    json[i]['item_mode'],
                    json[i]['quantity'],
                    json[i]['price_mode'],
                    json[i]['price'],
                    json[i]['price_minus_sum'],
                    json[i]['price_minus_percent'],
                    // $("<div/>").html(json[i]['name']).text(),
                    HTMLDecode(json[i]['name']),
                    json[i]['main'],
                    json[i]['item_position'],
                    json[i]['item_type'],
                    json[i]['has_options'],
                    json[i]['disable_options'],
                    json[i]['enabled_options'],
                    json[i]['fixed_options'],
                    json[i]['store_status'],
                    parseInt(json[i]['item_empty_mode_enable']),
                    parseInt(json[i]['item_empty_mode_default_empty']),
                    parseInt(json[i]['item_empty_mode_not_empty_in_cart']),
                    json[i]['item_empty_mode_title'],
                    parseInt(json[i]['quantity_edit']),
                    parseInt(json[i]['free_product_default_in_kit']),
                    json[i]['hide_special_products'],
                    json[i]['products_combine_mode'],
                    json[i]['empty_group_image'],
                    json[i]['empty_group_image_thumb'],
                    json[i]['randomize_select_product'],
                    json[i]['custom_field'],
                    json[i]['price_mode_to_customer_groups_status'],
                    json[i]['price_mode_to_customer_groups'],

                    // json[i]['disable_options_info_string']
                    // json[i]['fixed_options_info_string']

                );
            }

            update_views();

        }

        $(document).ready(function() {
            init_add_products();
        });
        //15911


        update_views();

        function HTMLDecode(s) {
            return jQuery('<div></div>').html(s).text();
        }

        //--></script>

    <script type="text/javascript"><!--

        function init_autocomplete_kit_widget(element) {
            $(element).autocomplete({
                'source': function (request, response) {
                    var data = [];

                    var data = $('#kit-widgets').find('input.input-widget-id').serializeArray();

                    data = $(data).add({name: 'filter_name', value: encodeURIComponent(request)});

                    $.ajax({
                        url: 'index.php?route=catalog/bundle_expert_kit/autocomplete_kit_widget&{{ token_name }}{{ token_value }}',
                        type: 'post',
                        data: data,
                        dataType: 'json',
                        success: function (json) {
                            response($.map(json, function (item, index) {
                                return {
                                    widget_id: item['widget_id'],
                                    label: item['name'],
                                    href: item['href'],
                                    value: index,
                                }
                            }));
                        }
                    });
                },
                'select': function (item) {
                    $(element).parent().find('.input-widget-id').val(item['widget_id']);
                    $(element).parent().find('.input-widget-name').val(item['label']);
                    $(element).closest('[id^=kit-widget-row]').find('.input-widget-href').attr('href', item['href']);
                }
            });


        }

        $('[id^=kit-widget-row] input.input-widget-name').each(function (index, element) {
            init_autocomplete_kit_widget(element);
        })

        var kit_widget_row = {{ kit_widget_row }};

        function addKitWidget() {

            html = '<tr id="kit-widget-row' + kit_widget_row + '">';
            html += ' <td><input type="hidden" name="kit_widgets[' + kit_widget_row + '][widget_id]" value="" class="form-control input-widget-id" />';
            html += '  <input type="text" name="kit_widgets[' + kit_widget_row + '][name]" value="" placeholder="" class="form-control input-widget-name" />';
            html += ' </td>';
            // html += '  <td class="text-right"><input type="text" name="widget_kits[' + widget_kit_row + '][sort_order]" value="" class="form-control" /></td>';
            html += '  <td class="text-right"><a data-toggle="tooltip" title="" class="btn btn-default input-kit-href"><i class="fa fa-pencil"></i></a> </td>';

            html += '  <td class="text-right"><button type="button" onclick="$(\'#kit-widget-row' + kit_widget_row + '\').remove();" data-toggle="tooltip" title="" class="btn btn-danger"><i class="fa fa-minus-circle"></i></button></td>';
            html += '</tr>';

            $('#kit-widgets tbody').append(html);

            init_autocomplete_kit_widget($('#kit-widgets tbody .input-widget-name').last());

            kit_widget_row++;
        }


        $('button[type=\'submit\']').on('click', function (e) {
            if ($("form[id*='form-']").length > 0) {
                e.preventDefault();
                $("form[id*='form-']").submit();
            }
        });
        //--></script>

    <script type="text/javascript"><!--
        var kit_period_row = {{ kit_period_row }};

        function addKitPeriod() {
            html = '<tr id="kit-period-row' + kit_period_row + '">';
            html += '  <td class="text-left"><select name="kit_period[' + kit_period_row + '][customer_group_id]" class="form-control">';
            {% for customer_group in customer_groups %}
            html += '      <option value="{{ customer_group['customer_group_id'] }}">{{ customer_group['name'] }}</option>';
            {% endfor %}
            html += '  </select></td>';
            html += '  <td class="text-right"><input type="text" name="kit_period[' + kit_period_row + '][priority]" value="" placeholder="{{ entry_priority }}" class="form-control" /></td>';
            html += '  <td class="text-left" style="width: 20%;"><div class="input-group date"><input type="text" name="kit_period[' + kit_period_row + '][date_start]" value="" placeholder="{{ entry_date_start }}" data-date-format="YYYY-MM-DD" class="form-control" /><span class="input-group-btn"><button type="button" class="btn btn-default"><i class="fa fa-calendar"></i></button></span></div></td>';
            html += '  <td class="text-left" style="width: 20%;"><div class="input-group date"><input type="text" name="kit_period[' + kit_period_row + '][date_end]" value="" placeholder="{{ entry_date_end }}" data-date-format="YYYY-MM-DD" class="form-control" /><span class="input-group-btn"><button type="button" class="btn btn-default"><i class="fa fa-calendar"></i></button></span></div></td>';
            html += '  <td class="text-left"><button type="button" onclick="$(\'#kit-period-row' + kit_period_row + '\').remove();" data-toggle="tooltip" title="{{ button_remove }}" class="btn btn-danger"><i class="fa fa-minus-circle"></i></button></td>';
            html += '</tr>';

            $('#kit-period tbody').append(html);

            $('.date').datetimepicker({
                pickTime: false
            });

            kit_period_row++;
        }

        function delete_kit(element) {

            var url = $(element).attr('data-href');

            location = url;
        }

        // function on_filter_button() {
        //     if ($('#filter-button').hasClass('active')) {
        //         $('#filter-button').removeClass('active');
        //         $('#autocomplete-filter').hide();
        //     } else {
        //         $('#filter-button').addClass('active');
        //         $('#autocomplete-filter').show();
        //     }
        // }

        //--></script>

    <script type="text/javascript"><!--
        $('.date').datetimepicker({
            pickTime: false
        });

        $('.time').datetimepicker({
            pickDate: false
        });

        $('.datetime').datetimepicker({
            pickDate: true,
            pickTime: true
        });



        //Т.к. у элементов list+product нет конкретных name, то добавляем их отдельно
        function add_list_product_data(data) {
            var list_product_form = $('form').find('#tab-product .form-group-main-product, #tab-product #form-group-kit-product');
            var inputs = $(list_product_form).find('input[type=\'text\'], input[type=\'hidden\'], input[type=\'radio\']:checked, input[type=\'checkbox\']:checked, select, textarea');

            for (i = 0; i < $(inputs).length; i++) {
                var input = inputs[i];

                var name = $(input).attr('be_input_name');
                var value = $(input).val();

                data = $(data).add({name: name, value: value});


            }

            return data;
        }

        function save_kit_ajax(button, save_and_stay, complete_function, complete_function_parameter) {



            var data = $('form').find('input[type=\'text\'], input[type=\'hidden\'], input[type=\'radio\']:checked, input[type=\'checkbox\']:checked, select, textarea').serializeArray();

            data = add_list_product_data(data);

            data = $(data).add({name: save_and_stay, value: save_and_stay});

            $.ajax({
                url: '{{ save_kit_ajax_href }}',
                type: 'post',
                data: data,
                dataType: 'json',
                beforeSend: function() {
                    $(button).button('loading');
                    $('.alert').replaceWith('');
                    $('.text-danger').replaceWith('');
                },
                complete: function() {
                    $(button).button('reset');
                },
                success: function (json) {
                    $(button).button('reset');

                    if (json['error']) {
                        if (json['error']['warning']) {
                            $('.breadcrumb').after('<div class="alert alert-warning">' + json['error']['warning'] + '<button type="button" class="close" data-dismiss="alert">&times;</button></div>');
                        }

                        if (json['error']['link_product']) {
                            $('.kit-link-product-error-container').html('<div class="text-danger">' + json['error']['link_product'] + '<button type="button" class="close" data-dismiss="alert">&times;</button></div>');
                        }
                        if (json['error']['name']) {
                            for (i in json['error']['name']) {
                                $('.kit-name-error-container' + i).html('<div class="text-danger">' + json['error']['name'][i] + '<button type="button" class="close" data-dismiss="alert">&times;</button></div>');
                            }
                        }


                    }

                    if (json['success']) {
                        $('input[name=kit_id]').val(json['kit_id']);

                        if(json['new_kit']){
                            var new_url = 'index.php?route=catalog/bundle_expert/edit&{{ token_name }}{{ token_value }}&kit_id='+json['kit_id'];
                            window.history.replaceState(null, null, new_url);
                        }

                        $('.breadcrumb').after('<div class="alert alert-success">' + json['success'] + '<button type="button" class="close" data-dismiss="alert">&times;</button></div>');
                    }

                    if(typeof complete_function !=="undefined"){
                        complete_function(complete_function_parameter);
                    }

                    if(!save_and_stay){
                        if (!json['error']) {
                            if (json['redirect']) {
                                location = json['redirect'];
                            }
                        }
                    }
                }
            });
        }

        //--></script>
</div>
